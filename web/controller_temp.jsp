<%@page import="org.apache.commons.fileupload.FileItem" %>
    <%@page import="org.apache.commons.fileupload.disk.DiskFileItemFactory" %>
        <%@page import="org.apache.commons.fileupload.servlet.ServletFileUpload" %>
            <%@ page import="java.time.LocalTime" %>
                <%@ page import="java.time.temporal.ChronoUnit" %>
                    <%@ page import="java.time.format.DateTimeFormatter" %>
                        <%@ page import="java.util.*" %>
                            <%@ page import="java.util.List" %>
                                <%@ page import="java.io.*" %>
                                    <%@ page import="java.io.InputStream" %>
                                        <%@ page import="java.io.PrintWriter" %>
                                            <%@ page import="java.util.logging.Level" %>
                                                <%@ page import="java.util.logging.Logger" %>
                                                    <%@ page import="java.sql.Connection" %>
                                                        <%@ page import="java.sql.PreparedStatement" %>
                                                            <%@ page import="java.sql.SQLException" %>
                                                                <%@ page import="java.sql.ResultSet" %>
                                                                    <%@ page import="myPackage.*" %>
                                                                        <%@ page import="myPackage.classes.User" %>
                                                                            <%@ page
                                                                                import="myPackage.classes.Questions" %>
                                                                                <%@ page
                                                                                    import="myPackage.classes.Courses"
                                                                                    %>
                                                                                    <%@ page
                                                                                        import="org.mindrot.jbcrypt.BCrypt"
                                                                                        %>
                                                                                        <%@ page
                                                                                            import="org.json.JSONObject"
                                                                                            %>
                                                                                            <%@ page
                                                                                                import="org.json.JSONArray"
                                                                                                %>
                                                                                                <%@ page
                                                                                                    import="org.json.JSONException"
                                                                                                    %>
                                                                                                    <%@ page
                                                                                                        import="myPackage.classes.DraggableItem"
                                                                                                        %>
                                                                                                        <%@ page
                                                                                                            import="myPackage.classes.DropZone"
                                                                                                            %>
                                                                                                            <%@ page
                                                                                                                import="org.apache.pdfbox.pdmodel.PDDocument"
                                                                                                                %>
                                                                                                                <%@ page
                                                                                                                    import="org.apache.pdfbox.text.PDFTextStripper"
                                                                                                                    %>
                                                                                                                    <%@ page
                                                                                                                        contentType="text/html"
                                                                                                                        pageEncoding="UTF-8"
                                                                                                                        %>
                                                                                                                        <%@ page
                                                                                                                            trimDirectiveWhitespaces="true"
                                                                                                                            %>

                                                                                                                            <% myPackage.DatabaseClass
                                                                                                                                pDAO=myPackage.DatabaseClass.getInstance();
                                                                                                                                final
                                                                                                                                Logger
                                                                                                                                LOGGER=Logger.getLogger("controller.jsp");
                                                                                                                                /**
                                                                                                                                Returns
                                                                                                                                value
                                                                                                                                if
                                                                                                                                non-null/non-empty,
                                                                                                                                otherwise
                                                                                                                                fallback.
                                                                                                                                */
                                                                                                                                %>
                                                                                                                                <%! private
                                                                                                                                    String
                                                                                                                                    nz(String
                                                                                                                                    v,
                                                                                                                                    String
                                                                                                                                    fallback){
                                                                                                                                    return
                                                                                                                                    (v
                                                                                                                                    !=null
                                                                                                                                    &&
                                                                                                                                    !v.trim().isEmpty())
                                                                                                                                    ?
                                                                                                                                    v.trim()
                                                                                                                                    :
                                                                                                                                    fallback;
                                                                                                                                    }
                                                                                                                                    %>

                                                                                                                                    <% try
                                                                                                                                        {
                                                                                                                                        String
                                                                                                                                        actionParamEarly=request.getParameter("action");
                                                                                                                                        if
                                                                                                                                        (actionParamEarly
                                                                                                                                        !=null
                                                                                                                                        && "check_signup_code_email"
                                                                                                                                        .equalsIgnoreCase(actionParamEarly))
                                                                                                                                        {
                                                                                                                                        response.setContentType("application/json");
                                                                                                                                        PrintWriter
                                                                                                                                        outJSON=response.getWriter();
                                                                                                                                        JSONObject
                                                                                                                                        res=new
                                                                                                                                        JSONObject();
                                                                                                                                        String
                                                                                                                                        email=nz(request.getParameter("email"), ""
                                                                                                                                        );
                                                                                                                                        if
                                                                                                                                        (email.isEmpty())
                                                                                                                                        {
                                                                                                                                        res.put("exists",
                                                                                                                                        false);
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        boolean
                                                                                                                                        exists=pDAO.signupCodeEmailExists(email);
                                                                                                                                        res.put("exists",
                                                                                                                                        exists);
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (actionParamEarly
                                                                                                                                        !=null
                                                                                                                                        && "verify_signup_code_and_register_lecture"
                                                                                                                                        .equalsIgnoreCase(actionParamEarly))
                                                                                                                                        {
                                                                                                                                        response.setContentType("application/json");
                                                                                                                                        PrintWriter
                                                                                                                                        outJSON=response.getWriter();
                                                                                                                                        JSONObject
                                                                                                                                        res=new
                                                                                                                                        JSONObject();
                                                                                                                                        String
                                                                                                                                        fName=nz(request.getParameter("fname"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        lName=nz(request.getParameter("lname"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        uName=nz(request.getParameter("uname"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        email=nz(request.getParameter("email"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        pass=nz(request.getParameter("pass"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        contactNo=nz(request.getParameter("contactno"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        city=nz(request.getParameter("city"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        address=nz(request.getParameter("address"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        code=nz(request.getParameter("code"), ""
                                                                                                                                        );
                                                                                                                                        if
                                                                                                                                        (fName.isEmpty()
                                                                                                                                        ||
                                                                                                                                        lName.isEmpty()
                                                                                                                                        ||
                                                                                                                                        uName.isEmpty()
                                                                                                                                        ||
                                                                                                                                        email.isEmpty()
                                                                                                                                        ||
                                                                                                                                        pass.isEmpty()
                                                                                                                                        ||
                                                                                                                                        code.isEmpty())
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message", "Missing required fields."
                                                                                                                                        );
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (!uName.matches("\\d{8}"))
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message", "ID number must be exactly 8 digits."
                                                                                                                                        );
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        try
                                                                                                                                        {
                                                                                                                                        String
                                                                                                                                        hashedPass=PasswordUtils.bcryptHashPassword(pass);
                                                                                                                                        boolean
                                                                                                                                        ok=pDAO.registerLecturerFromSignupCode(fName,
                                                                                                                                        lName,
                                                                                                                                        uName,
                                                                                                                                        email,
                                                                                                                                        hashedPass,
                                                                                                                                        contactNo,
                                                                                                                                        city,
                                                                                                                                        address,
                                                                                                                                        code);
                                                                                                                                        if
                                                                                                                                        (ok)
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        true);
                                                                                                                                        res.put("message", "Lecturer registration successful! Please login."
                                                                                                                                        );
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message", "Invalid signup code."
                                                                                                                                        );
                                                                                                                                        }
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        catch
                                                                                                                                        (RuntimeException
                                                                                                                                        ex)
                                                                                                                                        {
                                                                                                                                        LOGGER.log(Level.SEVERE, "Error registering lecturer from signup code"
                                                                                                                                        ,
                                                                                                                                        ex);
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message", "Registration failed. "
                                                                                                                                        +
                                                                                                                                        ex.getMessage());
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        catch
                                                                                                                                        (Exception
                                                                                                                                        ex)
                                                                                                                                        {
                                                                                                                                        LOGGER.log(Level.SEVERE, "Error hashing password/processing lecturer signup"
                                                                                                                                        ,
                                                                                                                                        ex);
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message", "Registration failed."
                                                                                                                                        );
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (actionParamEarly
                                                                                                                                        !=null
                                                                                                                                        && "lecturer_request"
                                                                                                                                        .equalsIgnoreCase(actionParamEarly))
                                                                                                                                        {
                                                                                                                                        response.setContentType("application/json");
                                                                                                                                        PrintWriter
                                                                                                                                        outJSON=response.getWriter();
                                                                                                                                        JSONObject
                                                                                                                                        res=new
                                                                                                                                        JSONObject();
                                                                                                                                        String
                                                                                                                                        firstNames=nz(request.getParameter("firstNames"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        surname=nz(request.getParameter("surname"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        lecturerLegacy=nz(request.getParameter("lecturer"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        staffNumber=nz(request.getParameter("staffNumber"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        email=nz(request.getParameter("email"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        course=nz(request.getParameter("course"), ""
                                                                                                                                        );
                                                                                                                                        String
                                                                                                                                        contact=nz(request.getParameter("contact"), ""
                                                                                                                                        );
                                                                                                                                        if
                                                                                                                                        ((firstNames.isEmpty()
                                                                                                                                        ||
                                                                                                                                        surname.isEmpty())
                                                                                                                                        &&
                                                                                                                                        !lecturerLegacy.isEmpty())
                                                                                                                                        {
                                                                                                                                        String[]
                                                                                                                                        parts=lecturerLegacy.trim().split("\\s+",
                                                                                                                                        2);
                                                                                                                                        if
                                                                                                                                        (firstNames.isEmpty()
                                                                                                                                        &&
                                                                                                                                        parts.length>
                                                                                                                                        0)
                                                                                                                                        firstNames
                                                                                                                                        =
                                                                                                                                        parts[0];
                                                                                                                                        if
                                                                                                                                        (surname.isEmpty()
                                                                                                                                        &&
                                                                                                                                        parts.length
                                                                                                                                        >
                                                                                                                                        1)
                                                                                                                                        surname
                                                                                                                                        =
                                                                                                                                        parts[1];
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (firstNames.isEmpty()
                                                                                                                                        &&
                                                                                                                                        !lecturerLegacy.isEmpty())
                                                                                                                                        {
                                                                                                                                        firstNames
                                                                                                                                        =
                                                                                                                                        lecturerLegacy;
                                                                                                                                        }

                                                                                                                                        if
                                                                                                                                        (firstNames.isEmpty()
                                                                                                                                        ||
                                                                                                                                        surname.isEmpty()
                                                                                                                                        ||
                                                                                                                                        staffNumber.isEmpty()
                                                                                                                                        ||
                                                                                                                                        email.isEmpty()
                                                                                                                                        ||
                                                                                                                                        course.isEmpty()
                                                                                                                                        ||
                                                                                                                                        contact.isEmpty())
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message",
                                                                                                                                        "Please
                                                                                                                                        fill
                                                                                                                                        in
                                                                                                                                        all
                                                                                                                                        fields.");
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (!staffNumber.matches("\\d{6}"))
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message",
                                                                                                                                        "Staff
                                                                                                                                        Number
                                                                                                                                        must
                                                                                                                                        be
                                                                                                                                        exactly
                                                                                                                                        6
                                                                                                                                        digits.");
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }
                                                                                                                                        if
                                                                                                                                        (!email.matches("^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"))
                                                                                                                                        {
                                                                                                                                        res.put("success",
                                                                                                                                        false);
                                                                                                                                        res.put("message",
                                                                                                                                        "Please
                                                                                                                                        enter
                                                                                                                                        a
                                                                                                                                        valid
                                                                                                                                        email
                                                                                                                                        address.");
                                                                                                                                        outJSON.print(res.toString());
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        String
                                                                                                                                        alphabet
                                                                                                                                        =
                                                                                                                                        "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                                                                                                                                        java.security.SecureRandom
                                                                                                                                        rnd
                                                                                                                                        =
                                                                                                                                        new
                                                                                                                                        java.security.SecureRandom();
                                                                                                                                        StringBuilder
                                                                                                                                        sb
                                                                                                                                        =
                                                                                                                                        new
                                                                                                                                        StringBuilder(6);
                                                                                                                                        for
                                                                                                                                        (int
                                                                                                                                        i
                                                                                                                                        =
                                                                                                                                        0;
                                                                                                                                        i
                                                                                                                                        < 6; i++)
                                                                                                                                            {
                                                                                                                                            sb.append(alphabet.charAt(rnd.nextInt(alphabet.length())));
                                                                                                                                            }
                                                                                                                                            String
                                                                                                                                            signupCode=sb.toString();
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            boolean
                                                                                                                                            stored=pDAO.storeSignupCode(firstNames,
                                                                                                                                            surname,
                                                                                                                                            email,
                                                                                                                                            signupCode);
                                                                                                                                            if
                                                                                                                                            (!stored)
                                                                                                                                            {
                                                                                                                                            res.put("success",
                                                                                                                                            false);
                                                                                                                                            res.put("message", "Could not store signup code. Please try again later."
                                                                                                                                            );
                                                                                                                                            outJSON.print(res.toString());
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            Email.sendLecturerRequestEmail(firstNames,
                                                                                                                                            surname,
                                                                                                                                            staffNumber,
                                                                                                                                            email,
                                                                                                                                            course,
                                                                                                                                            contact,
                                                                                                                                            signupCode);
                                                                                                                                            res.put("success",
                                                                                                                                            true);
                                                                                                                                            res.put("message", "Request sent successfully."
                                                                                                                                            );
                                                                                                                                            outJSON.print(res.toString());
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (Throwable
                                                                                                                                            mailErr)
                                                                                                                                            {
                                                                                                                                            LOGGER.log(Level.SEVERE, "Failed to send lecturer request email"
                                                                                                                                            ,
                                                                                                                                            mailErr);
                                                                                                                                            res.put("success",
                                                                                                                                            false);
                                                                                                                                            res.put("message", "Could not send request email. Please try again later."
                                                                                                                                            );
                                                                                                                                            outJSON.print(res.toString());
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            String
                                                                                                                                            pageParam=request.getParameter("page");
                                                                                                                                            //
                                                                                                                                            Special
                                                                                                                                            handling
                                                                                                                                            for
                                                                                                                                            multipart
                                                                                                                                            form
                                                                                                                                            submissions
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            multipart
                                                                                                                                            forms,
                                                                                                                                            we
                                                                                                                                            can't
                                                                                                                                            rely
                                                                                                                                            on
                                                                                                                                            request.getParameter()
                                                                                                                                            initially
                                                                                                                                            //
                                                                                                                                            So
                                                                                                                                            we
                                                                                                                                            check
                                                                                                                                            if
                                                                                                                                            this
                                                                                                                                            might
                                                                                                                                            be
                                                                                                                                            a
                                                                                                                                            questions
                                                                                                                                            edit
                                                                                                                                            operation
                                                                                                                                            if
                                                                                                                                            (pageParam==null
                                                                                                                                            &&
                                                                                                                                            ServletFileUpload.isMultipartContent(request))
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Parse
                                                                                                                                            the
                                                                                                                                            multipart
                                                                                                                                            request
                                                                                                                                            to
                                                                                                                                            extract
                                                                                                                                            the
                                                                                                                                            page
                                                                                                                                            parameter
                                                                                                                                            DiskFileItemFactory
                                                                                                                                            factory=new
                                                                                                                                            DiskFileItemFactory();
                                                                                                                                            factory.setSizeThreshold(1024
                                                                                                                                            *
                                                                                                                                            1024
                                                                                                                                            *
                                                                                                                                            3);
                                                                                                                                            //
                                                                                                                                            3
                                                                                                                                            MB
                                                                                                                                            factory.setRepository(new
                                                                                                                                            File(request.getServletContext().getAttribute("javax.servlet.context.tempdir")
                                                                                                                                            !=null
                                                                                                                                            ?
                                                                                                                                            request.getServletContext().getAttribute("javax.servlet.context.tempdir").toString()
                                                                                                                                            : "/tmp"
                                                                                                                                            ));
                                                                                                                                            ServletFileUpload
                                                                                                                                            upload=new
                                                                                                                                            ServletFileUpload(factory);
                                                                                                                                            upload.setSizeMax(1024
                                                                                                                                            *
                                                                                                                                            1024
                                                                                                                                            *
                                                                                                                                            10);
                                                                                                                                            //
                                                                                                                                            10
                                                                                                                                            MB
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            List<FileItem>
                                                                                                                                            items
                                                                                                                                            =
                                                                                                                                            upload.parseRequest(request);

                                                                                                                                            //
                                                                                                                                            First
                                                                                                                                            pass:
                                                                                                                                            extract
                                                                                                                                            page,
                                                                                                                                            operation,
                                                                                                                                            and
                                                                                                                                            qid
                                                                                                                                            parameters
                                                                                                                                            String
                                                                                                                                            operationParam
                                                                                                                                            =
                                                                                                                                            null;
                                                                                                                                            String
                                                                                                                                            qidParam
                                                                                                                                            =
                                                                                                                                            null;
                                                                                                                                            for
                                                                                                                                            (FileItem
                                                                                                                                            item
                                                                                                                                            :
                                                                                                                                            items)
                                                                                                                                            {
                                                                                                                                            if
                                                                                                                                            (item.isFormField())
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            fieldName
                                                                                                                                            =
                                                                                                                                            item.getFieldName();
                                                                                                                                            if
                                                                                                                                            ("page".equals(fieldName))
                                                                                                                                            {
                                                                                                                                            pageParam
                                                                                                                                            =
                                                                                                                                            item.getString("UTF-8");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("operation".equals(fieldName))
                                                                                                                                            {
                                                                                                                                            operationParam
                                                                                                                                            =
                                                                                                                                            item.getString("UTF-8");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("qid".equals(fieldName))
                                                                                                                                            {
                                                                                                                                            qidParam
                                                                                                                                            =
                                                                                                                                            item.getString("UTF-8");
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            If
                                                                                                                                            page
                                                                                                                                            parameter
                                                                                                                                            was
                                                                                                                                            found
                                                                                                                                            in
                                                                                                                                            multipart
                                                                                                                                            data,
                                                                                                                                            we
                                                                                                                                            continue
                                                                                                                                            //
                                                                                                                                            Otherwise,
                                                                                                                                            we
                                                                                                                                            redirect
                                                                                                                                            to
                                                                                                                                            login
                                                                                                                                            if
                                                                                                                                            (pageParam
                                                                                                                                            ==
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Store
                                                                                                                                            operation
                                                                                                                                            parameter
                                                                                                                                            in
                                                                                                                                            request
                                                                                                                                            for
                                                                                                                                            later
                                                                                                                                            use
                                                                                                                                            request.setAttribute("multipartOperation",
                                                                                                                                            operationParam);

                                                                                                                                            //
                                                                                                                                            Store
                                                                                                                                            qid
                                                                                                                                            parameter
                                                                                                                                            in
                                                                                                                                            request
                                                                                                                                            for
                                                                                                                                            later
                                                                                                                                            use
                                                                                                                                            request.setAttribute("multipartQid",
                                                                                                                                            qidParam);

                                                                                                                                            //
                                                                                                                                            Store
                                                                                                                                            the
                                                                                                                                            parsed
                                                                                                                                            items
                                                                                                                                            in
                                                                                                                                            request
                                                                                                                                            attributes
                                                                                                                                            for
                                                                                                                                            later
                                                                                                                                            use
                                                                                                                                            by
                                                                                                                                            the
                                                                                                                                            respective
                                                                                                                                            handlers
                                                                                                                                            request.setAttribute("multipartItems",
                                                                                                                                            items);

                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (Exception
                                                                                                                                            e)
                                                                                                                                            {
                                                                                                                                            e.printStackTrace();
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            (pageParam
                                                                                                                                            ==
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            non-multipart
                                                                                                                                            requests,
                                                                                                                                            redirect
                                                                                                                                            if
                                                                                                                                            no
                                                                                                                                            page
                                                                                                                                            parameter
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            multipart
                                                                                                                                            requests,
                                                                                                                                            we
                                                                                                                                            continue
                                                                                                                                            processing
                                                                                                                                            after
                                                                                                                                            storing
                                                                                                                                            the
                                                                                                                                            items
                                                                                                                                            //
                                                                                                                                            The
                                                                                                                                            page
                                                                                                                                            and
                                                                                                                                            operation
                                                                                                                                            parameters
                                                                                                                                            have
                                                                                                                                            been
                                                                                                                                            extracted
                                                                                                                                            and
                                                                                                                                            stored

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            DUPLICATE
                                                                                                                                            CHECKING
                                                                                                                                            ENDPOINTS
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            if
                                                                                                                                            ("check_username".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            username
                                                                                                                                            =
                                                                                                                                            request.getParameter("username");
                                                                                                                                            boolean
                                                                                                                                            exists
                                                                                                                                            =
                                                                                                                                            pDAO.checkUsernameExists(username);
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.getWriter().write("{\"exists\":
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            exists
                                                                                                                                            +
                                                                                                                                            "}");
                                                                                                                                            return;

                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("check_email".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            email
                                                                                                                                            =
                                                                                                                                            request.getParameter("email");
                                                                                                                                            boolean
                                                                                                                                            exists
                                                                                                                                            =
                                                                                                                                            pDAO.checkEmailExists(email);
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.getWriter().write("{\"exists\":
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            exists
                                                                                                                                            +
                                                                                                                                            "}");
                                                                                                                                            return;

                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("check_contact".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            contactNo
                                                                                                                                            =
                                                                                                                                            request.getParameter("contactno");
                                                                                                                                            boolean
                                                                                                                                            exists
                                                                                                                                            =
                                                                                                                                            pDAO.checkContactNoExists(contactNo);
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.getWriter().write("{\"exists\":
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            exists
                                                                                                                                            +
                                                                                                                                            "}");
                                                                                                                                            return;

                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("check_staff_email".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            email
                                                                                                                                            =
                                                                                                                                            request.getParameter("email");
                                                                                                                                            boolean
                                                                                                                                            exists
                                                                                                                                            =
                                                                                                                                            pDAO.checkStaffEmailExists(email);
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.getWriter().write("{\"exists\":
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            exists
                                                                                                                                            +
                                                                                                                                            "}");
                                                                                                                                            return;

                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("check_user_exists".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            username
                                                                                                                                            =
                                                                                                                                            request.getParameter("username");
                                                                                                                                            boolean
                                                                                                                                            exists
                                                                                                                                            =
                                                                                                                                            pDAO.checkUserExists(username);
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.getWriter().write("{\"exists\":
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            exists
                                                                                                                                            +
                                                                                                                                            "}");
                                                                                                                                            return;

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            LOGIN
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("login".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            userName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("username"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            userPass
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("password"),
                                                                                                                                            "");

                                                                                                                                            if
                                                                                                                                            (pDAO.loginValidate(userName,
                                                                                                                                            userPass))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("success",
                                                                                                                                            "Welcome
                                                                                                                                            back!");
                                                                                                                                            session.setAttribute("userStatus",
                                                                                                                                            "1");
                                                                                                                                            session.setAttribute("userId",
                                                                                                                                            pDAO.getUserId(userName));
                                                                                                                                            //
                                                                                                                                            Forward
                                                                                                                                            to
                                                                                                                                            transition
                                                                                                                                            page
                                                                                                                                            so
                                                                                                                                            client-side
                                                                                                                                            loader
                                                                                                                                            has
                                                                                                                                            time
                                                                                                                                            to
                                                                                                                                            display
                                                                                                                                            request.setAttribute("targetUrl",
                                                                                                                                            "dashboard.jsp");
                                                                                                                                            request.setAttribute("message",
                                                                                                                                            "Logging
                                                                                                                                            you
                                                                                                                                            in...");
                                                                                                                                            request.setAttribute("delayMs",
                                                                                                                                            Integer.valueOf(5000));
                                                                                                                                            request.getRequestDispatcher("transition.jsp").forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Invalid
                                                                                                                                            username
                                                                                                                                            or
                                                                                                                                            password");
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            }
                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            REGISTER
                                                                                                                                            (WITH
                                                                                                                                            ENHANCED
                                                                                                                                            VALIDATION)
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("register".equalsIgnoreCase(pageParam))
                                                                                                                                            {

                                                                                                                                            //
                                                                                                                                            Use
                                                                                                                                            character
                                                                                                                                            encoding
                                                                                                                                            for
                                                                                                                                            proper
                                                                                                                                            parameter
                                                                                                                                            handling
                                                                                                                                            request.setCharacterEncoding("UTF-8");

                                                                                                                                            String
                                                                                                                                            fName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("fname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            lName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("lname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            uName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("uname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            email
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("email"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            pass
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("pass"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            contactNo
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("contactno"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            city
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("city"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            address
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("address"),
                                                                                                                                            "");

                                                                                                                                            String
                                                                                                                                            userType
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("user_type"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            fromPage
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("from_page"),
                                                                                                                                            "");

                                                                                                                                            //
                                                                                                                                            Store
                                                                                                                                            all
                                                                                                                                            form
                                                                                                                                            data
                                                                                                                                            in
                                                                                                                                            request
                                                                                                                                            attributes
                                                                                                                                            for
                                                                                                                                            repopulation
                                                                                                                                            request.setAttribute("fname",
                                                                                                                                            fName);
                                                                                                                                            request.setAttribute("lname",
                                                                                                                                            lName);
                                                                                                                                            request.setAttribute("uname",
                                                                                                                                            uName);
                                                                                                                                            request.setAttribute("email",
                                                                                                                                            email);
                                                                                                                                            request.setAttribute("contactno",
                                                                                                                                            contactNo);
                                                                                                                                            request.setAttribute("city",
                                                                                                                                            city);
                                                                                                                                            request.setAttribute("address",
                                                                                                                                            address);

                                                                                                                                            //
                                                                                                                                            Validate
                                                                                                                                            required
                                                                                                                                            fields
                                                                                                                                            if
                                                                                                                                            (fName.isEmpty()
                                                                                                                                            ||
                                                                                                                                            lName.isEmpty()
                                                                                                                                            ||
                                                                                                                                            uName.isEmpty()
                                                                                                                                            ||
                                                                                                                                            email.isEmpty()
                                                                                                                                            ||
                                                                                                                                            pass.isEmpty())
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Please
                                                                                                                                            fill
                                                                                                                                            in
                                                                                                                                            all
                                                                                                                                            required
                                                                                                                                            fields");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "required");
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Validate
                                                                                                                                            ID
                                                                                                                                            number
                                                                                                                                            format
                                                                                                                                            (8
                                                                                                                                            digits)
                                                                                                                                            if
                                                                                                                                            (!uName.matches("\\d{8}"))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "ID
                                                                                                                                            number
                                                                                                                                            must
                                                                                                                                            be
                                                                                                                                            exactly
                                                                                                                                            8
                                                                                                                                            digits");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "uname");
                                                                                                                                            //
                                                                                                                                            Clear
                                                                                                                                            only
                                                                                                                                            the
                                                                                                                                            ID
                                                                                                                                            field
                                                                                                                                            request.setAttribute("uname",
                                                                                                                                            "");
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Check
                                                                                                                                            for
                                                                                                                                            duplicates
                                                                                                                                            in
                                                                                                                                            ORDER:
                                                                                                                                            username
                                                                                                                                            â†’
                                                                                                                                            contact
                                                                                                                                            â†’
                                                                                                                                            email
                                                                                                                                            //
                                                                                                                                            1.
                                                                                                                                            Check
                                                                                                                                            username
                                                                                                                                            first
                                                                                                                                            if
                                                                                                                                            (pDAO.checkUsernameExists(uName))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            ID
                                                                                                                                            number
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "uname");
                                                                                                                                            //
                                                                                                                                            Clear
                                                                                                                                            only
                                                                                                                                            the
                                                                                                                                            ID
                                                                                                                                            field
                                                                                                                                            request.setAttribute("uname",
                                                                                                                                            "");
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            2.
                                                                                                                                            Check
                                                                                                                                            contact
                                                                                                                                            number
                                                                                                                                            second
                                                                                                                                            if
                                                                                                                                            (contactNo
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            !contactNo.isEmpty())
                                                                                                                                            {
                                                                                                                                            if
                                                                                                                                            (pDAO.checkContactNoExists(contactNo))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            contact
                                                                                                                                            number
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "contactno");
                                                                                                                                            //
                                                                                                                                            Clear
                                                                                                                                            only
                                                                                                                                            the
                                                                                                                                            contact
                                                                                                                                            field
                                                                                                                                            request.setAttribute("contactno",
                                                                                                                                            "");
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            3.
                                                                                                                                            Check
                                                                                                                                            email
                                                                                                                                            last
                                                                                                                                            if
                                                                                                                                            (pDAO.checkEmailExists(email))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            email
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "email");
                                                                                                                                            //
                                                                                                                                            Clear
                                                                                                                                            only
                                                                                                                                            the
                                                                                                                                            email
                                                                                                                                            field
                                                                                                                                            request.setAttribute("email",
                                                                                                                                            "");
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Hash
                                                                                                                                            password
                                                                                                                                            String
                                                                                                                                            hashedPass
                                                                                                                                            =
                                                                                                                                            PasswordUtils.bcryptHashPassword(pass);

                                                                                                                                            //
                                                                                                                                            Call
                                                                                                                                            the
                                                                                                                                            ORIGINAL
                                                                                                                                            addNewUser
                                                                                                                                            method
                                                                                                                                            which
                                                                                                                                            is
                                                                                                                                            void
                                                                                                                                            pDAO.addNewUser(fName,
                                                                                                                                            lName,
                                                                                                                                            uName,
                                                                                                                                            email,
                                                                                                                                            hashedPass,
                                                                                                                                            contactNo,
                                                                                                                                            city,
                                                                                                                                            address,
                                                                                                                                            userType);

                                                                                                                                            //
                                                                                                                                            Clear
                                                                                                                                            any
                                                                                                                                            previous
                                                                                                                                            error
                                                                                                                                            fields
                                                                                                                                            session.removeAttribute("errorField");

                                                                                                                                            //
                                                                                                                                            Set
                                                                                                                                            success
                                                                                                                                            message
                                                                                                                                            -
                                                                                                                                            FIXED:
                                                                                                                                            Use
                                                                                                                                            session
                                                                                                                                            attribute
                                                                                                                                            session.setAttribute("success",
                                                                                                                                            "Registration
                                                                                                                                            successful!
                                                                                                                                            You
                                                                                                                                            can
                                                                                                                                            now
                                                                                                                                            login.");

                                                                                                                                            //
                                                                                                                                            Determine
                                                                                                                                            redirect
                                                                                                                                            based
                                                                                                                                            on
                                                                                                                                            user
                                                                                                                                            type
                                                                                                                                            boolean
                                                                                                                                            isAdminOrLecturer
                                                                                                                                            =
                                                                                                                                            "admin".equalsIgnoreCase(userType)
                                                                                                                                            ||
                                                                                                                                            "lecture".equalsIgnoreCase(userType)
                                                                                                                                            ||
                                                                                                                                            "lecturer".equalsIgnoreCase(userType);

                                                                                                                                            if
                                                                                                                                            (isAdminOrLecturer
                                                                                                                                            ||
                                                                                                                                            "account".equalsIgnoreCase(fromPage))
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            admin/lecturer
                                                                                                                                            registrations
                                                                                                                                            session.setAttribute("message",
                                                                                                                                            "User
                                                                                                                                            added
                                                                                                                                            successfully!");
                                                                                                                                            response.sendRedirect("accounts.jsp");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Store
                                                                                                                                            success
                                                                                                                                            message
                                                                                                                                            in
                                                                                                                                            session
                                                                                                                                            ONLY
                                                                                                                                            session.setAttribute("success",
                                                                                                                                            "Registration
                                                                                                                                            successful!
                                                                                                                                            Please
                                                                                                                                            login.");

                                                                                                                                            //
                                                                                                                                            Redirect
                                                                                                                                            cleanly
                                                                                                                                            (NO
                                                                                                                                            query
                                                                                                                                            params)
                                                                                                                                            response.sendRedirect("login.jsp");

                                                                                                                                            }

                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (RuntimeException
                                                                                                                                            ex)
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            The
                                                                                                                                            addNewUser
                                                                                                                                            method
                                                                                                                                            throws
                                                                                                                                            RuntimeException
                                                                                                                                            on
                                                                                                                                            SQL
                                                                                                                                            failure

                                                                                                                                            //
                                                                                                                                            Check
                                                                                                                                            if
                                                                                                                                            duplicates
                                                                                                                                            were
                                                                                                                                            created
                                                                                                                                            despite
                                                                                                                                            checks
                                                                                                                                            boolean
                                                                                                                                            usernameCheck
                                                                                                                                            =
                                                                                                                                            pDAO.checkUsernameExists(uName);
                                                                                                                                            boolean
                                                                                                                                            emailCheck
                                                                                                                                            =
                                                                                                                                            pDAO.checkEmailExists(email);
                                                                                                                                            boolean
                                                                                                                                            contactCheck
                                                                                                                                            =
                                                                                                                                            contactNo
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            !contactNo.isEmpty()
                                                                                                                                            &&
                                                                                                                                            pDAO.checkContactNoExists(contactNo);

                                                                                                                                            if
                                                                                                                                            (usernameCheck)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            ID
                                                                                                                                            number
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "uname");
                                                                                                                                            request.setAttribute("uname",
                                                                                                                                            "");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            (contactCheck)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            contact
                                                                                                                                            number
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "contactno");
                                                                                                                                            request.setAttribute("contactno",
                                                                                                                                            "");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            (emailCheck)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "This
                                                                                                                                            email
                                                                                                                                            is
                                                                                                                                            already
                                                                                                                                            registered");
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "email");
                                                                                                                                            request.setAttribute("email",
                                                                                                                                            "");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Get
                                                                                                                                            the
                                                                                                                                            root
                                                                                                                                            cause
                                                                                                                                            Throwable
                                                                                                                                            cause
                                                                                                                                            =
                                                                                                                                            ex.getCause();
                                                                                                                                            String
                                                                                                                                            errorMsg
                                                                                                                                            =
                                                                                                                                            "Registration
                                                                                                                                            failed.
                                                                                                                                            ";
                                                                                                                                            if
                                                                                                                                            (cause
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            cause.getMessage()
                                                                                                                                            !=
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            if
                                                                                                                                            (cause.getMessage().contains("Duplicate"))
                                                                                                                                            {
                                                                                                                                            errorMsg
                                                                                                                                            +=
                                                                                                                                            "The
                                                                                                                                            information
                                                                                                                                            may
                                                                                                                                            already
                                                                                                                                            be
                                                                                                                                            registered.";
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            errorMsg
                                                                                                                                            +=
                                                                                                                                            "Database
                                                                                                                                            error:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            cause.getMessage();
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            errorMsg
                                                                                                                                            +=
                                                                                                                                            "Please
                                                                                                                                            check
                                                                                                                                            all
                                                                                                                                            fields
                                                                                                                                            and
                                                                                                                                            try
                                                                                                                                            again.";
                                                                                                                                            }
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            errorMsg);
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "general");
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Forward
                                                                                                                                            to
                                                                                                                                            signup
                                                                                                                                            page
                                                                                                                                            with
                                                                                                                                            all
                                                                                                                                            form
                                                                                                                                            data
                                                                                                                                            preserved
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);

                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (Exception
                                                                                                                                            e)
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Catch
                                                                                                                                            any
                                                                                                                                            other
                                                                                                                                            exceptions
                                                                                                                                            (like
                                                                                                                                            password
                                                                                                                                            hashing
                                                                                                                                            errors)

                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Registration
                                                                                                                                            failed:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            e.getMessage());
                                                                                                                                            session.setAttribute("errorField",
                                                                                                                                            "general");

                                                                                                                                            //
                                                                                                                                            Forward
                                                                                                                                            to
                                                                                                                                            signup
                                                                                                                                            page
                                                                                                                                            with
                                                                                                                                            all
                                                                                                                                            form
                                                                                                                                            data
                                                                                                                                            preserved
                                                                                                                                            request.getRequestDispatcher("signup.jsp?user_type="
                                                                                                                                            +
                                                                                                                                            userType).forward(request,
                                                                                                                                            response);
                                                                                                                                            }

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            STAFF
                                                                                                                                            REGISTER
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("registerStaff".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            fullNames
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("fullNames"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            staffNum
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("staffNum"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            email
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("email"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("course_name"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            fromPage
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("from_page"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            userType
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("user_type"),
                                                                                                                                            "");

                                                                                                                                            pDAO.addNewStaff(staffNum,
                                                                                                                                            email,
                                                                                                                                            fullNames,
                                                                                                                                            courseName);
                                                                                                                                            session.setAttribute("message",
                                                                                                                                            "Lecturer
                                                                                                                                            registered
                                                                                                                                            successfully!");

                                                                                                                                            if
                                                                                                                                            ("account".equalsIgnoreCase(fromPage)
                                                                                                                                            ||
                                                                                                                                            "admin".equalsIgnoreCase(userType)
                                                                                                                                            ||
                                                                                                                                            "lecture".equalsIgnoreCase(userType)
                                                                                                                                            ||
                                                                                                                                            "lecturer".equalsIgnoreCase(userType))
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=6");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("staff_Numbers.jsp");
                                                                                                                                            }

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            PROFILE
                                                                                                                                            UPDATE
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("profile".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            if
                                                                                                                                            (session.getAttribute("userId")
                                                                                                                                            ==
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            int
                                                                                                                                            uid
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(session.getAttribute("userId").toString());
                                                                                                                                            String
                                                                                                                                            contact
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("contactno"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            city
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("city"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            address
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("address"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("course_name"),
                                                                                                                                            "");

                                                                                                                                            User
                                                                                                                                            current
                                                                                                                                            =
                                                                                                                                            pDAO.getUserDetails(String.valueOf(uid));
                                                                                                                                            if
                                                                                                                                            (current
                                                                                                                                            ==
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "User
                                                                                                                                            not
                                                                                                                                            found");
                                                                                                                                            response.sendRedirect("login.jsp");
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            if
                                                                                                                                            ("lecture".equalsIgnoreCase(current.getType())
                                                                                                                                            ||
                                                                                                                                            "lecturer".equalsIgnoreCase(current.getType()))
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            rows
                                                                                                                                            =
                                                                                                                                            pDAO.updateLecturer(uid,
                                                                                                                                            current.getFirstName(),
                                                                                                                                            current.getLastName(),
                                                                                                                                            current.getUserName(),
                                                                                                                                            current.getEmail(),
                                                                                                                                            current.getPassword(),
                                                                                                                                            contact,
                                                                                                                                            city,
                                                                                                                                            address,
                                                                                                                                            current.getType(),
                                                                                                                                            courseName);
                                                                                                                                            if
                                                                                                                                            (rows
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            session.setAttribute("message","Profile
                                                                                                                                            updated
                                                                                                                                            successfully!");
                                                                                                                                            else
                                                                                                                                            session.setAttribute("error","Failed
                                                                                                                                            to
                                                                                                                                            update
                                                                                                                                            profile.");
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=0");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            rows
                                                                                                                                            =
                                                                                                                                            pDAO.updateStudent(uid,
                                                                                                                                            current.getFirstName(),
                                                                                                                                            current.getLastName(),
                                                                                                                                            current.getUserName(),
                                                                                                                                            current.getEmail(),
                                                                                                                                            current.getPassword(),
                                                                                                                                            contact,
                                                                                                                                            city,
                                                                                                                                            address,
                                                                                                                                            current.getType());
                                                                                                                                            if
                                                                                                                                            (rows
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            session.setAttribute("message","Profile
                                                                                                                                            updated
                                                                                                                                            successfully!");
                                                                                                                                            else
                                                                                                                                            session.setAttribute("error","Failed
                                                                                                                                            to
                                                                                                                                            update
                                                                                                                                            profile.");
                                                                                                                                            response.sendRedirect("std-page.jsp?pgprt=0");
                                                                                                                                            }

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            COURSES
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("courses".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            operation
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("operation"),
                                                                                                                                            "");

                                                                                                                                            if
                                                                                                                                            ("getCourseData".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("courseName"),
                                                                                                                                            "");
                                                                                                                                            response.setContentType("application/json");
                                                                                                                                            response.setCharacterEncoding("UTF-8");

                                                                                                                                            if
                                                                                                                                            (courseName.isEmpty())
                                                                                                                                            {
                                                                                                                                            JSONObject
                                                                                                                                            error
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            JSONObject();
                                                                                                                                            error.put("success",
                                                                                                                                            false);
                                                                                                                                            error.put("message",
                                                                                                                                            "Course
                                                                                                                                            name
                                                                                                                                            is
                                                                                                                                            required");
                                                                                                                                            out.print(error.toString());
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Fetch
                                                                                                                                            directly
                                                                                                                                            from
                                                                                                                                            DB
                                                                                                                                            here
                                                                                                                                            to
                                                                                                                                            avoid
                                                                                                                                            requiring
                                                                                                                                            a
                                                                                                                                            rebuilt
                                                                                                                                            DatabaseClass
                                                                                                                                            on
                                                                                                                                            the
                                                                                                                                            server
                                                                                                                                            classpath.
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            Connection
                                                                                                                                            conn
                                                                                                                                            =
                                                                                                                                            pDAO.getConnection();
                                                                                                                                            PreparedStatement
                                                                                                                                            ps
                                                                                                                                            =
                                                                                                                                            conn.prepareStatement(
                                                                                                                                            "SELECT
                                                                                                                                            course_name,
                                                                                                                                            total_marks,
                                                                                                                                            time,
                                                                                                                                            exam_date
                                                                                                                                            FROM
                                                                                                                                            courses
                                                                                                                                            WHERE
                                                                                                                                            course_name
                                                                                                                                            =
                                                                                                                                            ?"
                                                                                                                                            );
                                                                                                                                            ps.setString(1,
                                                                                                                                            courseName);
                                                                                                                                            ResultSet
                                                                                                                                            rs
                                                                                                                                            =
                                                                                                                                            ps.executeQuery();

                                                                                                                                            if
                                                                                                                                            (!rs.next())
                                                                                                                                            {
                                                                                                                                            JSONObject
                                                                                                                                            error
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            JSONObject();
                                                                                                                                            error.put("success",
                                                                                                                                            false);
                                                                                                                                            error.put("message",
                                                                                                                                            "Course
                                                                                                                                            not
                                                                                                                                            found");
                                                                                                                                            out.print(error.toString());
                                                                                                                                            rs.close();
                                                                                                                                            ps.close();
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            JSONObject
                                                                                                                                            json
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            JSONObject();
                                                                                                                                            json.put("success",
                                                                                                                                            true);
                                                                                                                                            json.put("courseName",
                                                                                                                                            rs.getString("course_name"));
                                                                                                                                            json.put("totalMarks",
                                                                                                                                            rs.getInt("total_marks"));
                                                                                                                                            json.put("time",
                                                                                                                                            rs.getString("time"));
                                                                                                                                            json.put("examDate",
                                                                                                                                            rs.getString("exam_date"));
                                                                                                                                            out.print(json.toString());

                                                                                                                                            rs.close();
                                                                                                                                            ps.close();
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (Exception
                                                                                                                                            ex)
                                                                                                                                            {
                                                                                                                                            LOGGER.log(Level.SEVERE,
                                                                                                                                            "getCourseData
                                                                                                                                            failed",
                                                                                                                                            ex);
                                                                                                                                            JSONObject
                                                                                                                                            error
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            JSONObject();
                                                                                                                                            error.put("success",
                                                                                                                                            false);
                                                                                                                                            error.put("message",
                                                                                                                                            "Server
                                                                                                                                            error:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            ex.getMessage());
                                                                                                                                            out.print(error.toString());
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            }

                                                                                                                                            if
                                                                                                                                            ("addnew".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");
                                                                                                                                            int
                                                                                                                                            totalMarks
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(nz(request.getParameter("totalmarks"),
                                                                                                                                            "0"));
                                                                                                                                            String
                                                                                                                                            time
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("time"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            examDate
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("examdate"),
                                                                                                                                            "");

                                                                                                                                            boolean
                                                                                                                                            success
                                                                                                                                            =
                                                                                                                                            pDAO.addNewCourse(courseName,
                                                                                                                                            totalMarks,
                                                                                                                                            time,
                                                                                                                                            examDate);
                                                                                                                                            session.setAttribute("message",
                                                                                                                                            success
                                                                                                                                            ?
                                                                                                                                            "Course
                                                                                                                                            added
                                                                                                                                            successfully"
                                                                                                                                            :
                                                                                                                                            "Error
                                                                                                                                            adding
                                                                                                                                            course");
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=2");

                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("del".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            cname
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("cname"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            (!cname.isEmpty())
                                                                                                                                            {
                                                                                                                                            pDAO.delCourse(cname);
                                                                                                                                            session.setAttribute("message","Course
                                                                                                                                            deleted
                                                                                                                                            successfully");
                                                                                                                                            }
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=2");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("toggle_status".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            cname
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("cname"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            (!cname.isEmpty())
                                                                                                                                            {
                                                                                                                                            pDAO.toggleCourseStatus(cname);
                                                                                                                                            session.setAttribute("message","Course
                                                                                                                                            status
                                                                                                                                            updated
                                                                                                                                            successfully");
                                                                                                                                            }
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=2");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("update_course".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            originalCourseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("original_course_name"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");
                                                                                                                                            int
                                                                                                                                            totalMarks
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(nz(request.getParameter("totalmarks"),
                                                                                                                                            "0"));
                                                                                                                                            String
                                                                                                                                            time
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("time"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            examDate
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("examdate"),
                                                                                                                                            "");

                                                                                                                                            boolean
                                                                                                                                            success
                                                                                                                                            =
                                                                                                                                            pDAO.updateCourse(originalCourseName,
                                                                                                                                            courseName,
                                                                                                                                            totalMarks,
                                                                                                                                            time,
                                                                                                                                            examDate);
                                                                                                                                            session.setAttribute("message",
                                                                                                                                            success
                                                                                                                                            ?
                                                                                                                                            "Course
                                                                                                                                            updated
                                                                                                                                            successfully"
                                                                                                                                            :
                                                                                                                                            "Error
                                                                                                                                            updating
                                                                                                                                            course");
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=2");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Invalid
                                                                                                                                            operation
                                                                                                                                            for
                                                                                                                                            courses");
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=2");
                                                                                                                                            }

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            EDIT
                                                                                                                                            USER
                                                                                                                                            (UPDATE
                                                                                                                                            ACCOUNT)
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("accounts".equalsIgnoreCase(pageParam)
                                                                                                                                            &&
                                                                                                                                            "edit".equalsIgnoreCase(nz(request.getParameter("operation"),
                                                                                                                                            "")))
                                                                                                                                            {
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            userId
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(request.getParameter("uid"));
                                                                                                                                            String
                                                                                                                                            firstName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("fname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            lastName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("lname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            userName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("uname"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            email
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("email"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            password
                                                                                                                                            =
                                                                                                                                            request.getParameter("pass");
                                                                                                                                            String
                                                                                                                                            userType
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("type"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            contact
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("contactno"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            city
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("city"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            address
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("address"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            courseName=
                                                                                                                                            nz(request.getParameter("course_name"),
                                                                                                                                            "");

                                                                                                                                            User
                                                                                                                                            existingUser
                                                                                                                                            =
                                                                                                                                            pDAO.getUserDetails(String.valueOf(userId));
                                                                                                                                            if
                                                                                                                                            (existingUser
                                                                                                                                            ==
                                                                                                                                            null)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error","User
                                                                                                                                            not
                                                                                                                                            found.");
                                                                                                                                            response.sendRedirect("edit-user.jsp?uid="
                                                                                                                                            +
                                                                                                                                            userId);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Check
                                                                                                                                            if
                                                                                                                                            username
                                                                                                                                            already
                                                                                                                                            exists
                                                                                                                                            for
                                                                                                                                            another
                                                                                                                                            user
                                                                                                                                            User
                                                                                                                                            userByUsername
                                                                                                                                            =
                                                                                                                                            pDAO.getUserByUsername(userName);
                                                                                                                                            if
                                                                                                                                            (userByUsername
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            userByUsername.getUserId()
                                                                                                                                            !=
                                                                                                                                            userId)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error","Username
                                                                                                                                            already
                                                                                                                                            exists.
                                                                                                                                            Please
                                                                                                                                            choose
                                                                                                                                            a
                                                                                                                                            different
                                                                                                                                            username.");
                                                                                                                                            response.sendRedirect("edit-user.jsp?uid="
                                                                                                                                            +
                                                                                                                                            userId);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Check
                                                                                                                                            if
                                                                                                                                            email
                                                                                                                                            already
                                                                                                                                            exists
                                                                                                                                            for
                                                                                                                                            another
                                                                                                                                            user
                                                                                                                                            User
                                                                                                                                            userByEmail
                                                                                                                                            =
                                                                                                                                            pDAO.getUserByEmail(email);
                                                                                                                                            if
                                                                                                                                            (userByEmail
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            userByEmail.getUserId()
                                                                                                                                            !=
                                                                                                                                            userId)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error","Email
                                                                                                                                            already
                                                                                                                                            exists.
                                                                                                                                            Please
                                                                                                                                            use
                                                                                                                                            a
                                                                                                                                            different
                                                                                                                                            email.");
                                                                                                                                            response.sendRedirect("edit-user.jsp?uid="
                                                                                                                                            +
                                                                                                                                            userId);
                                                                                                                                            return;
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Check
                                                                                                                                            if
                                                                                                                                            contact
                                                                                                                                            number
                                                                                                                                            already
                                                                                                                                            exists
                                                                                                                                            for
                                                                                                                                            another
                                                                                                                                            user
                                                                                                                                            if
                                                                                                                                            (contact
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            !contact.trim().isEmpty())
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            We
                                                                                                                                            need
                                                                                                                                            to
                                                                                                                                            check
                                                                                                                                            if
                                                                                                                                            contact
                                                                                                                                            exists
                                                                                                                                            for
                                                                                                                                            another
                                                                                                                                            user
                                                                                                                                            //
                                                                                                                                            We'll
                                                                                                                                            create
                                                                                                                                            a
                                                                                                                                            method
                                                                                                                                            to
                                                                                                                                            check
                                                                                                                                            this,
                                                                                                                                            but
                                                                                                                                            for
                                                                                                                                            now
                                                                                                                                            we'll
                                                                                                                                            skip
                                                                                                                                            }

                                                                                                                                            if
                                                                                                                                            (password
                                                                                                                                            ==
                                                                                                                                            null
                                                                                                                                            ||
                                                                                                                                            password.trim().isEmpty())
                                                                                                                                            {
                                                                                                                                            password
                                                                                                                                            =
                                                                                                                                            existingUser.getPassword();
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            password
                                                                                                                                            =
                                                                                                                                            BCrypt.hashpw(password,
                                                                                                                                            BCrypt.gensalt());
                                                                                                                                            }

                                                                                                                                            if
                                                                                                                                            (!"lecture".equalsIgnoreCase(userType)
                                                                                                                                            &&
                                                                                                                                            !"lecturer".equalsIgnoreCase(userType))
                                                                                                                                            {
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            "";
                                                                                                                                            }

                                                                                                                                            User
                                                                                                                                            updatedUser
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            User(userId,
                                                                                                                                            firstName,
                                                                                                                                            lastName,
                                                                                                                                            userName,
                                                                                                                                            email,
                                                                                                                                            password,
                                                                                                                                            userType,
                                                                                                                                            contact,
                                                                                                                                            city,
                                                                                                                                            address,
                                                                                                                                            courseName);

                                                                                                                                            boolean
                                                                                                                                            success
                                                                                                                                            =
                                                                                                                                            pDAO.updateUser(updatedUser);
                                                                                                                                            if
                                                                                                                                            (success)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("message",
                                                                                                                                            "User
                                                                                                                                            updated
                                                                                                                                            successfully!");
                                                                                                                                            response.sendRedirect("lecture".equalsIgnoreCase(userType)
                                                                                                                                            ||
                                                                                                                                            "lecturer".equalsIgnoreCase(userType)
                                                                                                                                            ?
                                                                                                                                            "adm-page.jsp?pgprt=6"
                                                                                                                                            :
                                                                                                                                            "adm-page.jsp?pgprt=1");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Failed
                                                                                                                                            to
                                                                                                                                            update
                                                                                                                                            user.");
                                                                                                                                            response.sendRedirect("edit-user.jsp?uid="
                                                                                                                                            +
                                                                                                                                            userId);
                                                                                                                                            }

                                                                                                                                            }
                                                                                                                                            catch(Exception
                                                                                                                                            e){
                                                                                                                                            e.printStackTrace();
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Error:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            e.getMessage());
                                                                                                                                            response.sendRedirect("edit-user.jsp?uid="
                                                                                                                                            +
                                                                                                                                            request.getParameter("uid"));
                                                                                                                                            }
                                                                                                                                            return;

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            ACCOUNTS
                                                                                                                                            (STUDENTS)
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("accounts".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            operation
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("operation"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            uidParam
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("uid"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            ("del".equalsIgnoreCase(operation)
                                                                                                                                            &&
                                                                                                                                            !uidParam.isEmpty())
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            userId
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(uidParam);
                                                                                                                                            //
                                                                                                                                            Use
                                                                                                                                            cascade
                                                                                                                                            delete
                                                                                                                                            instead
                                                                                                                                            of
                                                                                                                                            simple
                                                                                                                                            delete
                                                                                                                                            pDAO.deleteUserCascade(userId);
                                                                                                                                            session.setAttribute("message","Account
                                                                                                                                            and
                                                                                                                                            all
                                                                                                                                            associated
                                                                                                                                            data
                                                                                                                                            deleted
                                                                                                                                            successfully");
                                                                                                                                            }
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=1");

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            LECTURERS
                                                                                                                                            ACCOUNTS
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("Lecturers_accounts".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            operation
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("operation"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            uidParam
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("uid"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            ("del".equalsIgnoreCase(operation)
                                                                                                                                            &&
                                                                                                                                            !uidParam.isEmpty())
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            userId
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(uidParam);
                                                                                                                                            //
                                                                                                                                            Use
                                                                                                                                            cascade
                                                                                                                                            delete
                                                                                                                                            for
                                                                                                                                            consistency
                                                                                                                                            pDAO.deleteUserCascade(userId);
                                                                                                                                            session.setAttribute("message","Lecturer
                                                                                                                                            and
                                                                                                                                            all
                                                                                                                                            associated
                                                                                                                                            data
                                                                                                                                            deleted
                                                                                                                                            successfully");
                                                                                                                                            }
                                                                                                                                            response.sendRedirect("adm-page.jsp?pgprt=6");

                                                                                                                                            /*
                                                                                                                                            =========================
                                                                                                                                            QUESTIONS
                                                                                                                                            =========================
                                                                                                                                            */
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("questions".equalsIgnoreCase(pageParam))
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            multipart
                                                                                                                                            requests,
                                                                                                                                            operation
                                                                                                                                            parameter
                                                                                                                                            may
                                                                                                                                            be
                                                                                                                                            stored
                                                                                                                                            as
                                                                                                                                            attribute
                                                                                                                                            String
                                                                                                                                            operation
                                                                                                                                            =
                                                                                                                                            nz((String)
                                                                                                                                            request.getAttribute("multipartOperation"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            (operation.isEmpty())
                                                                                                                                            {
                                                                                                                                            operation
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("operation"),
                                                                                                                                            "");
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            ---
                                                                                                                                            START
                                                                                                                                            CSRF
                                                                                                                                            VALIDATION
                                                                                                                                            ---
                                                                                                                                            if
                                                                                                                                            ("del".equalsIgnoreCase(operation)
                                                                                                                                            ||
                                                                                                                                            "bulk_delete".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String
                                                                                                                                            submittedToken
                                                                                                                                            =
                                                                                                                                            request.getParameter("csrf_token");
                                                                                                                                            String
                                                                                                                                            sessionToken
                                                                                                                                            =
                                                                                                                                            (String)
                                                                                                                                            session.getAttribute("csrf_token");

                                                                                                                                            if
                                                                                                                                            (sessionToken
                                                                                                                                            ==
                                                                                                                                            null
                                                                                                                                            ||
                                                                                                                                            !sessionToken.equals(submittedToken))
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Invalid
                                                                                                                                            request.
                                                                                                                                            Please
                                                                                                                                            try
                                                                                                                                            again.");
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            (!courseName.isEmpty())
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Redirect
                                                                                                                                            back
                                                                                                                                            to
                                                                                                                                            the
                                                                                                                                            showall
                                                                                                                                            page
                                                                                                                                            with
                                                                                                                                            an
                                                                                                                                            error
                                                                                                                                            response.sendRedirect("showall.jsp?coursename="
                                                                                                                                            +
                                                                                                                                            java.net.URLEncoder.encode(courseName,
                                                                                                                                            "UTF-8")
                                                                                                                                            +
                                                                                                                                            "&error=csrf");
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("showall.jsp?error=csrf");
                                                                                                                                            }
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            //
                                                                                                                                            ---
                                                                                                                                            END
                                                                                                                                            CSRF
                                                                                                                                            VALIDATION
                                                                                                                                            ---

                                                                                                                                            if
                                                                                                                                            ("del".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            multipart
                                                                                                                                            requests,
                                                                                                                                            qid
                                                                                                                                            parameter
                                                                                                                                            may
                                                                                                                                            be
                                                                                                                                            stored
                                                                                                                                            as
                                                                                                                                            attribute
                                                                                                                                            String
                                                                                                                                            qid
                                                                                                                                            =
                                                                                                                                            nz((String)
                                                                                                                                            request.getAttribute("multipartQid"),
                                                                                                                                            "");
                                                                                                                                            if
                                                                                                                                            (qid.isEmpty())
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            For
                                                                                                                                            non-multipart
                                                                                                                                            requests,
                                                                                                                                            get
                                                                                                                                            qid
                                                                                                                                            from
                                                                                                                                            regular
                                                                                                                                            parameter
                                                                                                                                            qid
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("qid"),
                                                                                                                                            "");
                                                                                                                                            }
                                                                                                                                            if
                                                                                                                                            (!qid.isEmpty())
                                                                                                                                            {
                                                                                                                                            boolean
                                                                                                                                            success
                                                                                                                                            =
                                                                                                                                            pDAO.deleteQuestion(Integer.parseInt(qid));
                                                                                                                                            if
                                                                                                                                            (success)
                                                                                                                                            {
                                                                                                                                            session.setAttribute("message","Question
                                                                                                                                            deleted
                                                                                                                                            successfully");
                                                                                                                                            //
                                                                                                                                            Force
                                                                                                                                            full
                                                                                                                                            page
                                                                                                                                            refresh
                                                                                                                                            by
                                                                                                                                            redirecting
                                                                                                                                            to
                                                                                                                                            showall.jsp
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            timestamp
                                                                                                                                            =
                                                                                                                                            String.valueOf(new
                                                                                                                                            Date().getTime());
                                                                                                                                            if
                                                                                                                                            (!courseName.isEmpty())
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Add
                                                                                                                                            cache-busting
                                                                                                                                            parameter
                                                                                                                                            to
                                                                                                                                            ensure
                                                                                                                                            fresh
                                                                                                                                            page
                                                                                                                                            load
                                                                                                                                            response.sendRedirect("showall.jsp?coursename="
                                                                                                                                            +
                                                                                                                                            courseName
                                                                                                                                            +
                                                                                                                                            "&_="
                                                                                                                                            +
                                                                                                                                            timestamp);
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("showall.jsp?_="
                                                                                                                                            +
                                                                                                                                            timestamp);
                                                                                                                                            }
                                                                                                                                            return;
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            session.setAttribute("error",
                                                                                                                                            "Failed
                                                                                                                                            to
                                                                                                                                            delete
                                                                                                                                            question
                                                                                                                                            ID:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            qid);
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            //
                                                                                                                                            Redirect
                                                                                                                                            to
                                                                                                                                            showall.jsp
                                                                                                                                            even
                                                                                                                                            if
                                                                                                                                            no
                                                                                                                                            question
                                                                                                                                            ID
                                                                                                                                            was
                                                                                                                                            provided
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");
                                                                                                                                            String
                                                                                                                                            timestamp
                                                                                                                                            =
                                                                                                                                            String.valueOf(new
                                                                                                                                            Date().getTime());
                                                                                                                                            if
                                                                                                                                            (!courseName.isEmpty())
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("showall.jsp?coursename="
                                                                                                                                            +
                                                                                                                                            courseName
                                                                                                                                            +
                                                                                                                                            "&_="
                                                                                                                                            +
                                                                                                                                            timestamp);
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            {
                                                                                                                                            response.sendRedirect("showall.jsp?_="
                                                                                                                                            +
                                                                                                                                            timestamp);
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            else
                                                                                                                                            if
                                                                                                                                            ("bulk_delete".equalsIgnoreCase(operation))
                                                                                                                                            {
                                                                                                                                            String[]
                                                                                                                                            questionIds
                                                                                                                                            =
                                                                                                                                            request.getParameterValues("questionIds");
                                                                                                                                            String
                                                                                                                                            courseName
                                                                                                                                            =
                                                                                                                                            nz(request.getParameter("coursename"),
                                                                                                                                            "");

                                                                                                                                            if
                                                                                                                                            (questionIds
                                                                                                                                            !=
                                                                                                                                            null
                                                                                                                                            &&
                                                                                                                                            questionIds.length
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Convert
                                                                                                                                            string
                                                                                                                                            array
                                                                                                                                            to
                                                                                                                                            int
                                                                                                                                            array
                                                                                                                                            int[]
                                                                                                                                            questionIdArray
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            int[questionIds.length];
                                                                                                                                            int
                                                                                                                                            validCount
                                                                                                                                            =
                                                                                                                                            0;

                                                                                                                                            //
                                                                                                                                            Validate
                                                                                                                                            and
                                                                                                                                            convert
                                                                                                                                            question
                                                                                                                                            IDs
                                                                                                                                            for
                                                                                                                                            (String
                                                                                                                                            qid
                                                                                                                                            :
                                                                                                                                            questionIds)
                                                                                                                                            {
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            int
                                                                                                                                            id
                                                                                                                                            =
                                                                                                                                            Integer.parseInt(qid);
                                                                                                                                            questionIdArray[validCount++]
                                                                                                                                            =
                                                                                                                                            id;
                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (NumberFormatException
                                                                                                                                            e)
                                                                                                                                            {
                                                                                                                                            //
                                                                                                                                            Skip
                                                                                                                                            invalid
                                                                                                                                            IDs
                                                                                                                                            LOGGER.warning("Invalid
                                                                                                                                            question
                                                                                                                                            ID
                                                                                                                                            skipped:
                                                                                                                                            "
                                                                                                                                            +
                                                                                                                                            qid);
                                                                                                                                            }
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Create
                                                                                                                                            properly
                                                                                                                                            sized
                                                                                                                                            array
                                                                                                                                            with
                                                                                                                                            only
                                                                                                                                            valid
                                                                                                                                            IDs
                                                                                                                                            int[]
                                                                                                                                            validQuestionIds
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            int[validCount];
                                                                                                                                            for
                                                                                                                                            (int
                                                                                                                                            i
                                                                                                                                            =
                                                                                                                                            0;
                                                                                                                                            i
                                                                                                                                            < validCount;
                                                                                                                                                i++)
                                                                                                                                                {
                                                                                                                                                validQuestionIds[i]=questionIdArray[i];
                                                                                                                                                }
                                                                                                                                                questionIdArray=validQuestionIds;
                                                                                                                                                if
                                                                                                                                                (questionIdArray.length>
                                                                                                                                                0)
                                                                                                                                                {
                                                                                                                                                //
                                                                                                                                                Use
                                                                                                                                                the
                                                                                                                                                new
                                                                                                                                                bulk
                                                                                                                                                delete
                                                                                                                                                method
                                                                                                                                                int
                                                                                                                                                deletedCount
                                                                                                                                                =
                                                                                                                                                pDAO.deleteQuestions(questionIdArray);

                                                                                                                                                if
                                                                                                                                                (deletedCount
                                                                                                                                                >
                                                                                                                                                0)
                                                                                                                                                {
                                                                                                                                                session.setAttribute("message",
                                                                                                                                                deletedCount
                                                                                                                                                +
                                                                                                                                                "
                                                                                                                                                question(s)
                                                                                                                                                deleted
                                                                                                                                                successfully!");
                                                                                                                                                //
                                                                                                                                                Redirect
                                                                                                                                                to
                                                                                                                                                showall.jsp
                                                                                                                                                after
                                                                                                                                                successful
                                                                                                                                                bulk
                                                                                                                                                delete
                                                                                                                                                String
                                                                                                                                                timestamp
                                                                                                                                                =
                                                                                                                                                String.valueOf(new
                                                                                                                                                Date().getTime());
                                                                                                                                                if
                                                                                                                                                (!courseName.isEmpty())
                                                                                                                                                {
                                                                                                                                                response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                +
                                                                                                                                                courseName
                                                                                                                                                +
                                                                                                                                                "&_="
                                                                                                                                                +
                                                                                                                                                timestamp);
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                {
                                                                                                                                                response.sendRedirect("showall.jsp?_="
                                                                                                                                                +
                                                                                                                                                timestamp);
                                                                                                                                                }
                                                                                                                                                return;
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                {
                                                                                                                                                session.setAttribute("error",
                                                                                                                                                "Failed
                                                                                                                                                to
                                                                                                                                                delete
                                                                                                                                                selected
                                                                                                                                                questions.");
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                {
                                                                                                                                                session.setAttribute("error",
                                                                                                                                                "No
                                                                                                                                                valid
                                                                                                                                                questions
                                                                                                                                                selected
                                                                                                                                                for
                                                                                                                                                deletion.");
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                {
                                                                                                                                                session.setAttribute("error",
                                                                                                                                                "No
                                                                                                                                                questions
                                                                                                                                                selected
                                                                                                                                                for
                                                                                                                                                deletion.");
                                                                                                                                                }

                                                                                                                                                //
                                                                                                                                                Redirect
                                                                                                                                                to
                                                                                                                                                showall.jsp
                                                                                                                                                after
                                                                                                                                                unsuccessful
                                                                                                                                                bulk
                                                                                                                                                delete
                                                                                                                                                String
                                                                                                                                                timestamp
                                                                                                                                                =
                                                                                                                                                String.valueOf(new
                                                                                                                                                Date().getTime());
                                                                                                                                                if
                                                                                                                                                (!courseName.isEmpty())
                                                                                                                                                {
                                                                                                                                                response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                +
                                                                                                                                                courseName
                                                                                                                                                +
                                                                                                                                                "&_="
                                                                                                                                                +
                                                                                                                                                timestamp);
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                {
                                                                                                                                                response.sendRedirect("showall.jsp?_="
                                                                                                                                                +
                                                                                                                                                timestamp);
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                else
                                                                                                                                                if
                                                                                                                                                ("edit".equalsIgnoreCase(operation))
                                                                                                                                                {
                                                                                                                                                //
                                                                                                                                                For
                                                                                                                                                multipart
                                                                                                                                                requests,
                                                                                                                                                qid
                                                                                                                                                parameter
                                                                                                                                                may
                                                                                                                                                be
                                                                                                                                                stored
                                                                                                                                                as
                                                                                                                                                attribute
                                                                                                                                                String
                                                                                                                                                qid
                                                                                                                                                =
                                                                                                                                                nz((String)
                                                                                                                                                request.getAttribute("multipartQid"),
                                                                                                                                                "");
                                                                                                                                                if
                                                                                                                                                (qid.isEmpty())
                                                                                                                                                {
                                                                                                                                                //
                                                                                                                                                For
                                                                                                                                                non-multipart
                                                                                                                                                requests,
                                                                                                                                                get
                                                                                                                                                qid
                                                                                                                                                from
                                                                                                                                                regular
                                                                                                                                                parameter
                                                                                                                                                qid
                                                                                                                                                =
                                                                                                                                                nz(request.getParameter("qid"),
                                                                                                                                                "");
                                                                                                                                                }
                                                                                                                                                if
                                                                                                                                                (!qid.isEmpty())
                                                                                                                                                {
                                                                                                                                                Questions
                                                                                                                                                question
                                                                                                                                                =
                                                                                                                                                pDAO.getQuestionById(Integer.parseInt(qid));
                                                                                                                                                if
                                                                                                                                                (question
                                                                                                                                                !=
                                                                                                                                                null)
                                                                                                                                                {
                                                                                                                                                //
                                                                                                                                                Handle
                                                                                                                                                multipart
                                                                                                                                                form
                                                                                                                                                data
                                                                                                                                                if
                                                                                                                                                present
                                                                                                                                                (for
                                                                                                                                                image
                                                                                                                                                uploads)
                                                                                                                                                if
                                                                                                                                                (ServletFileUpload.isMultipartContent(request))
                                                                                                                                                {
                                                                                                                                                //
                                                                                                                                                Use
                                                                                                                                                the
                                                                                                                                                pre-parsed
                                                                                                                                                items
                                                                                                                                                from
                                                                                                                                                the
                                                                                                                                                beginning
                                                                                                                                                of
                                                                                                                                                the
                                                                                                                                                controller
                                                                                                                                                List
                                                                                                                                                <FileItem>
                                                                                                                                                    items
                                                                                                                                                    =
                                                                                                                                                    (List
                                                                                                                                                    <FileItem>
                                                                                                                                                        )
                                                                                                                                                        request.getAttribute("multipartItems");

                                                                                                                                                        //
                                                                                                                                                        If
                                                                                                                                                        items
                                                                                                                                                        weren't
                                                                                                                                                        pre-parsed,
                                                                                                                                                        parse
                                                                                                                                                        them
                                                                                                                                                        now
                                                                                                                                                        if
                                                                                                                                                        (items
                                                                                                                                                        ==
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        DiskFileItemFactory
                                                                                                                                                        factory
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        DiskFileItemFactory();

                                                                                                                                                        //
                                                                                                                                                        Set
                                                                                                                                                        factory
                                                                                                                                                        constraints
                                                                                                                                                        factory.setSizeThreshold(1024
                                                                                                                                                        *
                                                                                                                                                        1024
                                                                                                                                                        *
                                                                                                                                                        3);
                                                                                                                                                        //
                                                                                                                                                        3
                                                                                                                                                        MB
                                                                                                                                                        factory.setRepository(new
                                                                                                                                                        File(request.getServletContext().getAttribute("javax.servlet.context.tempdir")
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        ?
                                                                                                                                                        request.getServletContext().getAttribute("javax.servlet.context.tempdir").toString()
                                                                                                                                                        :
                                                                                                                                                        "/tmp"));

                                                                                                                                                        //
                                                                                                                                                        Create
                                                                                                                                                        a
                                                                                                                                                        new
                                                                                                                                                        file
                                                                                                                                                        upload
                                                                                                                                                        handler
                                                                                                                                                        ServletFileUpload
                                                                                                                                                        upload
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        ServletFileUpload(factory);

                                                                                                                                                        //
                                                                                                                                                        Set
                                                                                                                                                        overall
                                                                                                                                                        request
                                                                                                                                                        size
                                                                                                                                                        constraint
                                                                                                                                                        upload.setSizeMax(1024
                                                                                                                                                        *
                                                                                                                                                        1024
                                                                                                                                                        *
                                                                                                                                                        10);
                                                                                                                                                        //
                                                                                                                                                        10
                                                                                                                                                        MB

                                                                                                                                                        //
                                                                                                                                                        Parse
                                                                                                                                                        the
                                                                                                                                                        request
                                                                                                                                                        items
                                                                                                                                                        =
                                                                                                                                                        upload.parseRequest(request);
                                                                                                                                                        }

                                                                                                                                                        try
                                                                                                                                                        {

                                                                                                                                                        String
                                                                                                                                                        questionText
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        opt1
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        opt2
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        opt3
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        opt4
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        correctAnswer
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        courseName
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        questionType
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        String
                                                                                                                                                        currentImagePath
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        boolean
                                                                                                                                                        removeImage
                                                                                                                                                        =
                                                                                                                                                        false;
                                                                                                                                                        String
                                                                                                                                                        imagePath
                                                                                                                                                        =
                                                                                                                                                        null;

                                                                                                                                                        for
                                                                                                                                                        (FileItem
                                                                                                                                                        item
                                                                                                                                                        :
                                                                                                                                                        items)
                                                                                                                                                        {
                                                                                                                                                        if
                                                                                                                                                        (item.isFormField())
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Process
                                                                                                                                                        regular
                                                                                                                                                        form
                                                                                                                                                        field
                                                                                                                                                        String
                                                                                                                                                        fieldName
                                                                                                                                                        =
                                                                                                                                                        item.getFieldName();
                                                                                                                                                        String
                                                                                                                                                        fieldValue
                                                                                                                                                        =
                                                                                                                                                        item.getString("UTF-8");

                                                                                                                                                        if
                                                                                                                                                        ("question".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        questionText
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("opt1".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        opt1
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("opt2".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        opt2
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("opt3".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        opt3
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("opt4".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        opt4
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("correct".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        correctAnswer
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("coursename".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        courseName
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("questionType".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        questionType
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("currentImagePath".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        currentImagePath
                                                                                                                                                        =
                                                                                                                                                        nz(fieldValue,
                                                                                                                                                        "");
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("removeImage".equals(fieldName))
                                                                                                                                                        {
                                                                                                                                                        removeImage
                                                                                                                                                        =
                                                                                                                                                        "true".equals(fieldValue);
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Process
                                                                                                                                                        file
                                                                                                                                                        upload
                                                                                                                                                        field
                                                                                                                                                        -
                                                                                                                                                        ONLY
                                                                                                                                                        ACCEPT
                                                                                                                                                        IMAGES
                                                                                                                                                        String
                                                                                                                                                        fieldName
                                                                                                                                                        =
                                                                                                                                                        item.getFieldName();
                                                                                                                                                        String
                                                                                                                                                        fileName
                                                                                                                                                        =
                                                                                                                                                        item.getName();

                                                                                                                                                        if
                                                                                                                                                        (fieldName.equals("imageFile")
                                                                                                                                                        &&
                                                                                                                                                        fileName
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        &&
                                                                                                                                                        !fileName.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Check
                                                                                                                                                        file
                                                                                                                                                        extension
                                                                                                                                                        String
                                                                                                                                                        fileExtension
                                                                                                                                                        =
                                                                                                                                                        "";
                                                                                                                                                        int
                                                                                                                                                        dotIndex
                                                                                                                                                        =
                                                                                                                                                        fileName.lastIndexOf('.');
                                                                                                                                                        if
                                                                                                                                                        (dotIndex
                                                                                                                                                        >
                                                                                                                                                        0)
                                                                                                                                                        {
                                                                                                                                                        fileExtension
                                                                                                                                                        =
                                                                                                                                                        fileName.substring(dotIndex).toLowerCase();
                                                                                                                                                        }

                                                                                                                                                        //
                                                                                                                                                        List
                                                                                                                                                        of
                                                                                                                                                        allowed
                                                                                                                                                        image
                                                                                                                                                        extensions
                                                                                                                                                        String[]
                                                                                                                                                        allowedExtensions
                                                                                                                                                        =
                                                                                                                                                        {".jpg",
                                                                                                                                                        ".jpeg",
                                                                                                                                                        ".png",
                                                                                                                                                        ".gif",
                                                                                                                                                        ".webp",
                                                                                                                                                        ".bmp"};
                                                                                                                                                        boolean
                                                                                                                                                        isImage
                                                                                                                                                        =
                                                                                                                                                        false;
                                                                                                                                                        for
                                                                                                                                                        (String
                                                                                                                                                        ext
                                                                                                                                                        :
                                                                                                                                                        allowedExtensions)
                                                                                                                                                        {
                                                                                                                                                        if
                                                                                                                                                        (fileExtension.equals(ext))
                                                                                                                                                        {
                                                                                                                                                        isImage
                                                                                                                                                        =
                                                                                                                                                        true;
                                                                                                                                                        break;
                                                                                                                                                        }
                                                                                                                                                        }

                                                                                                                                                        if
                                                                                                                                                        (!isImage)
                                                                                                                                                        {
                                                                                                                                                        session.setAttribute("error",
                                                                                                                                                        "Only
                                                                                                                                                        image
                                                                                                                                                        files
                                                                                                                                                        are
                                                                                                                                                        allowed
                                                                                                                                                        (JPG,
                                                                                                                                                        JPEG,
                                                                                                                                                        PNG,
                                                                                                                                                        GIF,
                                                                                                                                                        WEBP,
                                                                                                                                                        BMP).");
                                                                                                                                                        String
                                                                                                                                                        redirectCourse
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("coursename"),
                                                                                                                                                        "");
                                                                                                                                                        if
                                                                                                                                                        (!redirectCourse.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                        +
                                                                                                                                                        redirectCourse);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp");
                                                                                                                                                        }
                                                                                                                                                        return;
                                                                                                                                                        }

                                                                                                                                                        //
                                                                                                                                                        Create
                                                                                                                                                        uploads
                                                                                                                                                        directory
                                                                                                                                                        if
                                                                                                                                                        it
                                                                                                                                                        doesn't
                                                                                                                                                        exist
                                                                                                                                                        String
                                                                                                                                                        uploadPath
                                                                                                                                                        =
                                                                                                                                                        getServletContext().getRealPath("/uploads/images");
                                                                                                                                                        File
                                                                                                                                                        uploadDir
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        File(uploadPath);
                                                                                                                                                        if
                                                                                                                                                        (!uploadDir.exists())
                                                                                                                                                        {
                                                                                                                                                        uploadDir.mkdirs();
                                                                                                                                                        }

                                                                                                                                                        //
                                                                                                                                                        Generate
                                                                                                                                                        unique
                                                                                                                                                        filename
                                                                                                                                                        using
                                                                                                                                                        current
                                                                                                                                                        time
                                                                                                                                                        long
                                                                                                                                                        timestamp
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        java.util.Date().getTime();
                                                                                                                                                        String
                                                                                                                                                        uniqueFileName
                                                                                                                                                        =
                                                                                                                                                        timestamp
                                                                                                                                                        +
                                                                                                                                                        "_"
                                                                                                                                                        +
                                                                                                                                                        new
                                                                                                                                                        File(fileName).getName();
                                                                                                                                                        File
                                                                                                                                                        uploadedFile
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        File(uploadDir,
                                                                                                                                                        uniqueFileName);

                                                                                                                                                        //
                                                                                                                                                        Save
                                                                                                                                                        the
                                                                                                                                                        file
                                                                                                                                                        item.write(uploadedFile);

                                                                                                                                                        //
                                                                                                                                                        Set
                                                                                                                                                        the
                                                                                                                                                        image
                                                                                                                                                        path
                                                                                                                                                        to
                                                                                                                                                        be
                                                                                                                                                        saved
                                                                                                                                                        in
                                                                                                                                                        database
                                                                                                                                                        imagePath
                                                                                                                                                        =
                                                                                                                                                        "uploads/images/"
                                                                                                                                                        +
                                                                                                                                                        uniqueFileName;
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        }

                                                                                                                                                        //
                                                                                                                                                        Update
                                                                                                                                                        question
                                                                                                                                                        object
                                                                                                                                                        with
                                                                                                                                                        extracted
                                                                                                                                                        values
                                                                                                                                                        question.setQuestion(questionText);
                                                                                                                                                        question.setOpt1(opt1);
                                                                                                                                                        question.setOpt2(opt2);
                                                                                                                                                        question.setOpt3(opt3);
                                                                                                                                                        question.setOpt4(opt4);
                                                                                                                                                        question.setCorrect(correctAnswer);
                                                                                                                                                        question.setCourseName(courseName);
                                                                                                                                                        question.setQuestionType(questionType);

                                                                                                                                                        //
                                                                                                                                                        Handle
                                                                                                                                                        image
                                                                                                                                                        logic
                                                                                                                                                        if
                                                                                                                                                        (removeImage)
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Remove
                                                                                                                                                        old
                                                                                                                                                        image
                                                                                                                                                        file
                                                                                                                                                        if
                                                                                                                                                        it
                                                                                                                                                        exists
                                                                                                                                                        if
                                                                                                                                                        (question.getImagePath()
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        &&
                                                                                                                                                        !question.getImagePath().isEmpty())
                                                                                                                                                        {
                                                                                                                                                        try
                                                                                                                                                        {
                                                                                                                                                        File
                                                                                                                                                        oldImage
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        File(getServletContext().getRealPath("/"
                                                                                                                                                        +
                                                                                                                                                        question.getImagePath()));
                                                                                                                                                        if
                                                                                                                                                        (oldImage.exists())
                                                                                                                                                        {
                                                                                                                                                        oldImage.delete();
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        catch
                                                                                                                                                        (Exception
                                                                                                                                                        e)
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Log
                                                                                                                                                        error
                                                                                                                                                        but
                                                                                                                                                        continue
                                                                                                                                                        application.log("Error
                                                                                                                                                        deleting
                                                                                                                                                        old
                                                                                                                                                        image:
                                                                                                                                                        "
                                                                                                                                                        +
                                                                                                                                                        e.getMessage());
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        question.setImagePath(null);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        (imagePath
                                                                                                                                                        !=
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        New
                                                                                                                                                        image
                                                                                                                                                        uploaded
                                                                                                                                                        -
                                                                                                                                                        remove
                                                                                                                                                        old
                                                                                                                                                        image
                                                                                                                                                        file
                                                                                                                                                        if
                                                                                                                                                        it
                                                                                                                                                        exists
                                                                                                                                                        if
                                                                                                                                                        (question.getImagePath()
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        &&
                                                                                                                                                        !question.getImagePath().isEmpty())
                                                                                                                                                        {
                                                                                                                                                        try
                                                                                                                                                        {
                                                                                                                                                        File
                                                                                                                                                        oldImage
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        File(getServletContext().getRealPath("/"
                                                                                                                                                        +
                                                                                                                                                        question.getImagePath()));
                                                                                                                                                        if
                                                                                                                                                        (oldImage.exists())
                                                                                                                                                        {
                                                                                                                                                        oldImage.delete();
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        catch
                                                                                                                                                        (Exception
                                                                                                                                                        e)
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Log
                                                                                                                                                        error
                                                                                                                                                        but
                                                                                                                                                        continue
                                                                                                                                                        application.log("Error
                                                                                                                                                        deleting
                                                                                                                                                        old
                                                                                                                                                        image:
                                                                                                                                                        "
                                                                                                                                                        +
                                                                                                                                                        e.getMessage());
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        question.setImagePath(imagePath);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Keep
                                                                                                                                                        existing
                                                                                                                                                        image
                                                                                                                                                        path
                                                                                                                                                        if
                                                                                                                                                        no
                                                                                                                                                        new
                                                                                                                                                        image
                                                                                                                                                        was
                                                                                                                                                        uploaded
                                                                                                                                                        and
                                                                                                                                                        not
                                                                                                                                                        removing
                                                                                                                                                        if
                                                                                                                                                        (currentImagePath
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        &&
                                                                                                                                                        !currentImagePath.isEmpty()
                                                                                                                                                        &&
                                                                                                                                                        question.getImagePath()
                                                                                                                                                        ==
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        question.setImagePath(currentImagePath);
                                                                                                                                                        }
                                                                                                                                                        }

                                                                                                                                                        pDAO.updateQuestion(question);
                                                                                                                                                        session.setAttribute("message","Question
                                                                                                                                                        updated
                                                                                                                                                        successfully");

                                                                                                                                                        //
                                                                                                                                                        Clean
                                                                                                                                                        up
                                                                                                                                                        multipart
                                                                                                                                                        items
                                                                                                                                                        attribute
                                                                                                                                                        to
                                                                                                                                                        prevent
                                                                                                                                                        reuse
                                                                                                                                                        request.removeAttribute("multipartItems");

                                                                                                                                                        //
                                                                                                                                                        Redirect
                                                                                                                                                        to
                                                                                                                                                        showall.jsp
                                                                                                                                                        after
                                                                                                                                                        editing
                                                                                                                                                        if
                                                                                                                                                        (!courseName.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                        +
                                                                                                                                                        courseName);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp");
                                                                                                                                                        }
                                                                                                                                                        return;
                                                                                                                                                        }
                                                                                                                                                        catch
                                                                                                                                                        (Exception
                                                                                                                                                        e)
                                                                                                                                                        {
                                                                                                                                                        e.printStackTrace();
                                                                                                                                                        session.setAttribute("error",
                                                                                                                                                        "Error
                                                                                                                                                        updating
                                                                                                                                                        question:
                                                                                                                                                        "
                                                                                                                                                        +
                                                                                                                                                        e.getMessage());
                                                                                                                                                        String
                                                                                                                                                        courseName
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("coursename"),
                                                                                                                                                        "");

                                                                                                                                                        //
                                                                                                                                                        Clean
                                                                                                                                                        up
                                                                                                                                                        multipart
                                                                                                                                                        items
                                                                                                                                                        attribute
                                                                                                                                                        to
                                                                                                                                                        prevent
                                                                                                                                                        reuse
                                                                                                                                                        request.removeAttribute("multipartItems");

                                                                                                                                                        if
                                                                                                                                                        (!courseName.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                        +
                                                                                                                                                        courseName);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp");
                                                                                                                                                        }
                                                                                                                                                        return;
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Handle
                                                                                                                                                        regular
                                                                                                                                                        form
                                                                                                                                                        submission
                                                                                                                                                        (without
                                                                                                                                                        file
                                                                                                                                                        upload)
                                                                                                                                                        question.setQuestion(nz(request.getParameter("question"),
                                                                                                                                                        ""));
                                                                                                                                                        question.setOpt1(nz(request.getParameter("opt1"),
                                                                                                                                                        ""));
                                                                                                                                                        question.setOpt2(nz(request.getParameter("opt2"),
                                                                                                                                                        ""));
                                                                                                                                                        question.setOpt3(nz(request.getParameter("opt3"),
                                                                                                                                                        ""));
                                                                                                                                                        question.setOpt4(nz(request.getParameter("opt4"),
                                                                                                                                                        ""));
                                                                                                                                                        question.setCorrect(nz(request.getParameter("correct"),
                                                                                                                                                        ""));
                                                                                                                                                        String
                                                                                                                                                        courseName
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("coursename"),
                                                                                                                                                        "");
                                                                                                                                                        question.setCourseName(courseName);
                                                                                                                                                        //
                                                                                                                                                        Also
                                                                                                                                                        get
                                                                                                                                                        and
                                                                                                                                                        set
                                                                                                                                                        question
                                                                                                                                                        type
                                                                                                                                                        for
                                                                                                                                                        regular
                                                                                                                                                        forms
                                                                                                                                                        String
                                                                                                                                                        questionType
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("questionType"),
                                                                                                                                                        "");
                                                                                                                                                        question.setQuestionType(questionType);

                                                                                                                                                        //
                                                                                                                                                        Handle
                                                                                                                                                        image
                                                                                                                                                        removal
                                                                                                                                                        for
                                                                                                                                                        regular
                                                                                                                                                        forms
                                                                                                                                                        String
                                                                                                                                                        removeImageParam
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("removeImage"),
                                                                                                                                                        "");
                                                                                                                                                        if
                                                                                                                                                        ("true".equals(removeImageParam))
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Remove
                                                                                                                                                        old
                                                                                                                                                        image
                                                                                                                                                        file
                                                                                                                                                        if
                                                                                                                                                        it
                                                                                                                                                        exists
                                                                                                                                                        if
                                                                                                                                                        (question.getImagePath()
                                                                                                                                                        !=
                                                                                                                                                        null
                                                                                                                                                        &&
                                                                                                                                                        !question.getImagePath().isEmpty())
                                                                                                                                                        {
                                                                                                                                                        try
                                                                                                                                                        {
                                                                                                                                                        File
                                                                                                                                                        oldImage
                                                                                                                                                        =
                                                                                                                                                        new
                                                                                                                                                        File(getServletContext().getRealPath("/"
                                                                                                                                                        +
                                                                                                                                                        question.getImagePath()));
                                                                                                                                                        if
                                                                                                                                                        (oldImage.exists())
                                                                                                                                                        {
                                                                                                                                                        oldImage.delete();
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        catch
                                                                                                                                                        (Exception
                                                                                                                                                        e)
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Log
                                                                                                                                                        error
                                                                                                                                                        but
                                                                                                                                                        continue
                                                                                                                                                        application.log("Error
                                                                                                                                                        deleting
                                                                                                                                                        old
                                                                                                                                                        image:
                                                                                                                                                        "
                                                                                                                                                        +
                                                                                                                                                        e.getMessage());
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        question.setImagePath(null);
                                                                                                                                                        }

                                                                                                                                                        pDAO.updateQuestion(question);
                                                                                                                                                        session.setAttribute("message","Question
                                                                                                                                                        updated
                                                                                                                                                        successfully");

                                                                                                                                                        //
                                                                                                                                                        Clean
                                                                                                                                                        up
                                                                                                                                                        multipart
                                                                                                                                                        items
                                                                                                                                                        attribute
                                                                                                                                                        if
                                                                                                                                                        it
                                                                                                                                                        exists
                                                                                                                                                        (for
                                                                                                                                                        consistency)
                                                                                                                                                        if
                                                                                                                                                        (request.getAttribute("multipartItems")
                                                                                                                                                        !=
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        request.removeAttribute("multipartItems");
                                                                                                                                                        }

                                                                                                                                                        //
                                                                                                                                                        Redirect
                                                                                                                                                        to
                                                                                                                                                        showall.jsp
                                                                                                                                                        after
                                                                                                                                                        editing
                                                                                                                                                        if
                                                                                                                                                        (!courseName.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                        +
                                                                                                                                                        courseName);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp");
                                                                                                                                                        }
                                                                                                                                                        return;
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        }
                                                                                                                                                        String
                                                                                                                                                        courseName
                                                                                                                                                        =
                                                                                                                                                        nz(request.getParameter("coursename"),
                                                                                                                                                        "");

                                                                                                                                                        //
                                                                                                                                                        Clean
                                                                                                                                                        up
                                                                                                                                                        multipart
                                                                                                                                                        attributes
                                                                                                                                                        if
                                                                                                                                                        they
                                                                                                                                                        exist
                                                                                                                                                        if
                                                                                                                                                        (request.getAttribute("multipartItems")
                                                                                                                                                        !=
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        request.removeAttribute("multipartItems");
                                                                                                                                                        }
                                                                                                                                                        if
                                                                                                                                                        (request.getAttribute("multipartQid")
                                                                                                                                                        !=
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        request.removeAttribute("multipartQid");
                                                                                                                                                        }
                                                                                                                                                        if
                                                                                                                                                        (request.getAttribute("multipartOperation")
                                                                                                                                                        !=
                                                                                                                                                        null)
                                                                                                                                                        {
                                                                                                                                                        request.removeAttribute("multipartOperation");
                                                                                                                                                        }

                                                                                                                                                        if
                                                                                                                                                        (!courseName.isEmpty())
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                        +
                                                                                                                                                        courseName);
                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        {
                                                                                                                                                        response.sendRedirect("showall.jsp");
                                                                                                                                                        }

                                                                                                                                                        }
                                                                                                                                                        else
                                                                                                                                                        if
                                                                                                                                                        ("addnew".equalsIgnoreCase(operation))
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Check
                                                                                                                                                        if
                                                                                                                                                        request
                                                                                                                                                        is
                                                                                                                                                        multipart
                                                                                                                                                        (has
                                                                                                                                                        file
                                                                                                                                                        upload)
                                                                                                                                                        if
                                                                                                                                                        (ServletFileUpload.isMultipartContent(request))
                                                                                                                                                        {
                                                                                                                                                        //
                                                                                                                                                        Use
                                                                                                                                                        the
                                                                                                                                                        pre-parsed
                                                                                                                                                        items
                                                                                                                                                        from
                                                                                                                                                        the
                                                                                                                                                        beginning
                                                                                                                                                        of
                                                                                                                                                        the
                                                                                                                                                        controller
                                                                                                                                                        List
                                                                                                                                                        <FileItem>
                                                                                                                                                            items
                                                                                                                                                            =
                                                                                                                                                            (List
                                                                                                                                                            <FileItem>
                                                                                                                                                                )
                                                                                                                                                                request.getAttribute("multipartItems");

                                                                                                                                                                //
                                                                                                                                                                If
                                                                                                                                                                items
                                                                                                                                                                weren't
                                                                                                                                                                pre-parsed,
                                                                                                                                                                parse
                                                                                                                                                                them
                                                                                                                                                                now
                                                                                                                                                                if
                                                                                                                                                                (items
                                                                                                                                                                ==
                                                                                                                                                                null)
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Create
                                                                                                                                                                a
                                                                                                                                                                factory
                                                                                                                                                                for
                                                                                                                                                                disk-based
                                                                                                                                                                file
                                                                                                                                                                items
                                                                                                                                                                DiskFileItemFactory
                                                                                                                                                                factory
                                                                                                                                                                =
                                                                                                                                                                new
                                                                                                                                                                DiskFileItemFactory();

                                                                                                                                                                //
                                                                                                                                                                Set
                                                                                                                                                                factory
                                                                                                                                                                constraints
                                                                                                                                                                factory.setSizeThreshold(1024
                                                                                                                                                                *
                                                                                                                                                                1024
                                                                                                                                                                *
                                                                                                                                                                3);
                                                                                                                                                                //
                                                                                                                                                                3
                                                                                                                                                                MB
                                                                                                                                                                //
                                                                                                                                                                Use
                                                                                                                                                                alternative
                                                                                                                                                                approach
                                                                                                                                                                for
                                                                                                                                                                temp
                                                                                                                                                                directory
                                                                                                                                                                factory.setRepository(new
                                                                                                                                                                File(request.getServletContext().getAttribute("javax.servlet.context.tempdir")
                                                                                                                                                                !=
                                                                                                                                                                null
                                                                                                                                                                ?
                                                                                                                                                                request.getServletContext().getAttribute("javax.servlet.context.tempdir").toString()
                                                                                                                                                                :
                                                                                                                                                                "/tmp"));

                                                                                                                                                                //
                                                                                                                                                                Create
                                                                                                                                                                a
                                                                                                                                                                new
                                                                                                                                                                file
                                                                                                                                                                upload
                                                                                                                                                                handler
                                                                                                                                                                ServletFileUpload
                                                                                                                                                                upload
                                                                                                                                                                =
                                                                                                                                                                new
                                                                                                                                                                ServletFileUpload(factory);

                                                                                                                                                                //
                                                                                                                                                                Set
                                                                                                                                                                overall
                                                                                                                                                                request
                                                                                                                                                                size
                                                                                                                                                                constraint
                                                                                                                                                                upload.setSizeMax(1024
                                                                                                                                                                *
                                                                                                                                                                1024
                                                                                                                                                                *
                                                                                                                                                                10);
                                                                                                                                                                //
                                                                                                                                                                10
                                                                                                                                                                MB

                                                                                                                                                                //
                                                                                                                                                                Parse
                                                                                                                                                                the
                                                                                                                                                                request
                                                                                                                                                                items
                                                                                                                                                                =
                                                                                                                                                                upload.parseRequest(request);
                                                                                                                                                                }

                                                                                                                                                                try
                                                                                                                                                                {

                                                                                                                                                                String
                                                                                                                                                                questionText
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                opt1
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                opt2
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                opt3
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                opt4
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                correctAnswer
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                courseName
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                questionType
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                correctMultiple
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                String
                                                                                                                                                                imagePath
                                                                                                                                                                =
                                                                                                                                                                null;

                                                                                                                                                                for
                                                                                                                                                                (FileItem
                                                                                                                                                                item
                                                                                                                                                                :
                                                                                                                                                                items)
                                                                                                                                                                {
                                                                                                                                                                if
                                                                                                                                                                (item.isFormField())
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Process
                                                                                                                                                                regular
                                                                                                                                                                form
                                                                                                                                                                field
                                                                                                                                                                String
                                                                                                                                                                fieldName
                                                                                                                                                                =
                                                                                                                                                                item.getFieldName();
                                                                                                                                                                String
                                                                                                                                                                fieldValue
                                                                                                                                                                =
                                                                                                                                                                item.getString("UTF-8");

                                                                                                                                                                if
                                                                                                                                                                ("question".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                questionText
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("opt1".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                opt1
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("opt2".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                opt2
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("opt3".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                opt3
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("opt4".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                opt4
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("correct".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                correctAnswer
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("coursename".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                courseName
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("questionType".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                questionType
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("correctMultiple".equals(fieldName))
                                                                                                                                                                {
                                                                                                                                                                correctMultiple
                                                                                                                                                                =
                                                                                                                                                                nz(fieldValue,
                                                                                                                                                                "");
                                                                                                                                                                }
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Process
                                                                                                                                                                file
                                                                                                                                                                upload
                                                                                                                                                                field
                                                                                                                                                                -
                                                                                                                                                                ONLY
                                                                                                                                                                ACCEPT
                                                                                                                                                                IMAGES
                                                                                                                                                                String
                                                                                                                                                                fieldName
                                                                                                                                                                =
                                                                                                                                                                item.getFieldName();
                                                                                                                                                                String
                                                                                                                                                                fileName
                                                                                                                                                                =
                                                                                                                                                                item.getName();

                                                                                                                                                                if
                                                                                                                                                                (fieldName.equals("imageFile")
                                                                                                                                                                &&
                                                                                                                                                                fileName
                                                                                                                                                                !=
                                                                                                                                                                null
                                                                                                                                                                &&
                                                                                                                                                                !fileName.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Check
                                                                                                                                                                file
                                                                                                                                                                extension
                                                                                                                                                                String
                                                                                                                                                                fileExtension
                                                                                                                                                                =
                                                                                                                                                                "";
                                                                                                                                                                int
                                                                                                                                                                dotIndex
                                                                                                                                                                =
                                                                                                                                                                fileName.lastIndexOf('.');
                                                                                                                                                                if
                                                                                                                                                                (dotIndex
                                                                                                                                                                >
                                                                                                                                                                0)
                                                                                                                                                                {
                                                                                                                                                                fileExtension
                                                                                                                                                                =
                                                                                                                                                                fileName.substring(dotIndex).toLowerCase();
                                                                                                                                                                }

                                                                                                                                                                //
                                                                                                                                                                List
                                                                                                                                                                of
                                                                                                                                                                allowed
                                                                                                                                                                image
                                                                                                                                                                extensions
                                                                                                                                                                String[]
                                                                                                                                                                allowedExtensions
                                                                                                                                                                =
                                                                                                                                                                {".jpg",
                                                                                                                                                                ".jpeg",
                                                                                                                                                                ".png",
                                                                                                                                                                ".gif",
                                                                                                                                                                ".webp",
                                                                                                                                                                ".bmp"};
                                                                                                                                                                boolean
                                                                                                                                                                isImage
                                                                                                                                                                =
                                                                                                                                                                false;
                                                                                                                                                                for
                                                                                                                                                                (String
                                                                                                                                                                ext
                                                                                                                                                                :
                                                                                                                                                                allowedExtensions)
                                                                                                                                                                {
                                                                                                                                                                if
                                                                                                                                                                (fileExtension.equals(ext))
                                                                                                                                                                {
                                                                                                                                                                isImage
                                                                                                                                                                =
                                                                                                                                                                true;
                                                                                                                                                                break;
                                                                                                                                                                }
                                                                                                                                                                }

                                                                                                                                                                if
                                                                                                                                                                (!isImage)
                                                                                                                                                                {
                                                                                                                                                                session.setAttribute("error",
                                                                                                                                                                "Only
                                                                                                                                                                image
                                                                                                                                                                files
                                                                                                                                                                are
                                                                                                                                                                allowed
                                                                                                                                                                (JPG,
                                                                                                                                                                JPEG,
                                                                                                                                                                PNG,
                                                                                                                                                                GIF,
                                                                                                                                                                WEBP,
                                                                                                                                                                BMP).");
                                                                                                                                                                if
                                                                                                                                                                (!courseName.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                                +
                                                                                                                                                                courseName);
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp");
                                                                                                                                                                }
                                                                                                                                                                return;
                                                                                                                                                                }

                                                                                                                                                                //
                                                                                                                                                                Create
                                                                                                                                                                uploads
                                                                                                                                                                directory
                                                                                                                                                                if
                                                                                                                                                                it
                                                                                                                                                                doesn't
                                                                                                                                                                exist
                                                                                                                                                                String
                                                                                                                                                                uploadPath
                                                                                                                                                                =
                                                                                                                                                                getServletContext().getRealPath("/uploads/images");
                                                                                                                                                                File
                                                                                                                                                                uploadDir
                                                                                                                                                                =
                                                                                                                                                                new
                                                                                                                                                                File(uploadPath);
                                                                                                                                                                if
                                                                                                                                                                (!uploadDir.exists())
                                                                                                                                                                {
                                                                                                                                                                uploadDir.mkdirs();
                                                                                                                                                                }

                                                                                                                                                                //
                                                                                                                                                                Generate
                                                                                                                                                                unique
                                                                                                                                                                filename
                                                                                                                                                                using
                                                                                                                                                                current
                                                                                                                                                                time
                                                                                                                                                                long
                                                                                                                                                                timestamp
                                                                                                                                                                =
                                                                                                                                                                new
                                                                                                                                                                java.util.Date().getTime();
                                                                                                                                                                String
                                                                                                                                                                uniqueFileName
                                                                                                                                                                =
                                                                                                                                                                timestamp
                                                                                                                                                                +
                                                                                                                                                                "_"
                                                                                                                                                                +
                                                                                                                                                                new
                                                                                                                                                                File(fileName).getName();
                                                                                                                                                                File
                                                                                                                                                                uploadedFile
                                                                                                                                                                =
                                                                                                                                                                new
                                                                                                                                                                File(uploadDir,
                                                                                                                                                                uniqueFileName);

                                                                                                                                                                //
                                                                                                                                                                Save
                                                                                                                                                                the
                                                                                                                                                                file
                                                                                                                                                                item.write(uploadedFile);

                                                                                                                                                                //
                                                                                                                                                                Set
                                                                                                                                                                the
                                                                                                                                                                image
                                                                                                                                                                path
                                                                                                                                                                to
                                                                                                                                                                be
                                                                                                                                                                saved
                                                                                                                                                                in
                                                                                                                                                                database
                                                                                                                                                                imagePath
                                                                                                                                                                =
                                                                                                                                                                "uploads/images/"
                                                                                                                                                                +
                                                                                                                                                                uniqueFileName;
                                                                                                                                                                }
                                                                                                                                                                }
                                                                                                                                                                }

                                                                                                                                                                if
                                                                                                                                                                ("MultipleSelect".equalsIgnoreCase(questionType))
                                                                                                                                                                {
                                                                                                                                                                if
                                                                                                                                                                (!correctMultiple.isEmpty())
                                                                                                                                                                correctAnswer
                                                                                                                                                                =
                                                                                                                                                                correctMultiple;
                                                                                                                                                                }

                                                                                                                                                                pDAO.addNewQuestion(questionText,
                                                                                                                                                                opt1,
                                                                                                                                                                opt2,
                                                                                                                                                                opt3,
                                                                                                                                                                opt4,
                                                                                                                                                                correctAnswer,
                                                                                                                                                                courseName,
                                                                                                                                                                questionType,
                                                                                                                                                                imagePath);
                                                                                                                                                                session.setAttribute("message","Question
                                                                                                                                                                added
                                                                                                                                                                successfully");

                                                                                                                                                                //
                                                                                                                                                                Save
                                                                                                                                                                last
                                                                                                                                                                selections
                                                                                                                                                                to
                                                                                                                                                                session
                                                                                                                                                                session.setAttribute("last_course_name",
                                                                                                                                                                courseName);
                                                                                                                                                                session.setAttribute("last_question_type",
                                                                                                                                                                questionType);

                                                                                                                                                                //
                                                                                                                                                                Clean
                                                                                                                                                                up
                                                                                                                                                                multipart
                                                                                                                                                                items
                                                                                                                                                                attribute
                                                                                                                                                                to
                                                                                                                                                                prevent
                                                                                                                                                                reuse
                                                                                                                                                                request.removeAttribute("multipartItems");

                                                                                                                                                                if
                                                                                                                                                                (!courseName.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                                +
                                                                                                                                                                courseName);
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp");
                                                                                                                                                                }
                                                                                                                                                                return;
                                                                                                                                                                }
                                                                                                                                                                catch
                                                                                                                                                                (Exception
                                                                                                                                                                e)
                                                                                                                                                                {
                                                                                                                                                                e.printStackTrace();
                                                                                                                                                                session.setAttribute("error",
                                                                                                                                                                "Error
                                                                                                                                                                uploading
                                                                                                                                                                image:
                                                                                                                                                                "
                                                                                                                                                                +
                                                                                                                                                                e.getMessage());

                                                                                                                                                                //
                                                                                                                                                                Clean
                                                                                                                                                                up
                                                                                                                                                                multipart
                                                                                                                                                                items
                                                                                                                                                                attribute
                                                                                                                                                                to
                                                                                                                                                                prevent
                                                                                                                                                                reuse
                                                                                                                                                                request.removeAttribute("multipartItems");

                                                                                                                                                                response.sendRedirect("showall.jsp");
                                                                                                                                                                return;
                                                                                                                                                                }
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Handle
                                                                                                                                                                regular
                                                                                                                                                                form
                                                                                                                                                                submission
                                                                                                                                                                (without
                                                                                                                                                                file
                                                                                                                                                                upload)
                                                                                                                                                                String
                                                                                                                                                                questionText
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("question"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                opt1
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("opt1"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                opt2
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("opt2"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                opt3
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("opt3"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                opt4
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("opt4"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                correctAnswer
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("correct"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                courseName
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("coursename"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                questionType
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("questionType"),
                                                                                                                                                                "");

                                                                                                                                                                if
                                                                                                                                                                ("MultipleSelect".equalsIgnoreCase(questionType))
                                                                                                                                                                {
                                                                                                                                                                String
                                                                                                                                                                correctMultiple
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("correctMultiple"),
                                                                                                                                                                "");
                                                                                                                                                                if
                                                                                                                                                                (!correctMultiple.isEmpty())
                                                                                                                                                                correctAnswer
                                                                                                                                                                =
                                                                                                                                                                correctMultiple;
                                                                                                                                                                }

                                                                                                                                                                pDAO.addNewQuestion(questionText,
                                                                                                                                                                opt1,
                                                                                                                                                                opt2,
                                                                                                                                                                opt3,
                                                                                                                                                                opt4,
                                                                                                                                                                correctAnswer,
                                                                                                                                                                courseName,
                                                                                                                                                                questionType,
                                                                                                                                                                null);
                                                                                                                                                                session.setAttribute("message","Question
                                                                                                                                                                added
                                                                                                                                                                successfully");

                                                                                                                                                                //
                                                                                                                                                                Save
                                                                                                                                                                last
                                                                                                                                                                selections
                                                                                                                                                                to
                                                                                                                                                                session
                                                                                                                                                                session.setAttribute("last_course_name",
                                                                                                                                                                courseName);
                                                                                                                                                                session.setAttribute("last_question_type",
                                                                                                                                                                questionType);

                                                                                                                                                                courseName
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("coursename"),
                                                                                                                                                                "");
                                                                                                                                                                if
                                                                                                                                                                (!courseName.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp?coursename="
                                                                                                                                                                +
                                                                                                                                                                courseName);
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                {
                                                                                                                                                                response.sendRedirect("showall.jsp");
                                                                                                                                                                }
                                                                                                                                                                }
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("save_selection".equalsIgnoreCase(operation))
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Save
                                                                                                                                                                last
                                                                                                                                                                course
                                                                                                                                                                name
                                                                                                                                                                and
                                                                                                                                                                question
                                                                                                                                                                type
                                                                                                                                                                to
                                                                                                                                                                session
                                                                                                                                                                String
                                                                                                                                                                lastCourseName
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("last_course_name"),
                                                                                                                                                                "");
                                                                                                                                                                String
                                                                                                                                                                lastQuestionType
                                                                                                                                                                =
                                                                                                                                                                nz(request.getParameter("last_question_type"),
                                                                                                                                                                "");

                                                                                                                                                                if
                                                                                                                                                                (!lastCourseName.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                session.setAttribute("last_course_name",
                                                                                                                                                                lastCourseName);
                                                                                                                                                                }
                                                                                                                                                                if
                                                                                                                                                                (!lastQuestionType.isEmpty())
                                                                                                                                                                {
                                                                                                                                                                session.setAttribute("last_question_type",
                                                                                                                                                                lastQuestionType);
                                                                                                                                                                }

                                                                                                                                                                //
                                                                                                                                                                Return
                                                                                                                                                                success
                                                                                                                                                                response
                                                                                                                                                                for
                                                                                                                                                                AJAX
                                                                                                                                                                response.setContentType("application/json");
                                                                                                                                                                response.getWriter().write("{\"success\":
                                                                                                                                                                true}");
                                                                                                                                                                return;
                                                                                                                                                                }
                                                                                                                                                                else
                                                                                                                                                                if
                                                                                                                                                                ("pdf_upload".equalsIgnoreCase(request.getParameter("action")))
                                                                                                                                                                {
                                                                                                                                                                //
                                                                                                                                                                Handle
                                                                                                                                                                PDF
                                                                                                                                                                upload
                                                                                                                                                                and
                                                                                                                                                                text
                                                                                                                                                                extraction
                                                                                                                                                                response.setContentType("application/json");
                                                                                                                                                                PrintWriter
                                                                                                                                                                outJSON
                                                                                                                                                                =
                                                                                                                                                                response.getWriter();

                                                                                                                                                                //
                                                                                                                                                                Check
                                                                                                                                                                if
                                                                                                                                                                PDFBox
                                                                                                                                                                is
                                                                                                                                                                available
                                                                                                                                                                try
                                                                                                                                                                {
                                                                                                                                                                Class.forName("org.apache.pdfbox.pdmodel.PDDocument");
                                                                                                                                                                Class.forName("org.apache.pdfbox.text.PDFTextStripper");
                                                                                                                                                                }
                                                                                                                                                                catch
                                                                                                                                                                (Throwable
                                                                                                                                                                e)
                                                                                                                                                                {
                                                                                                                                                                LOGGER.log(Level.WARNING,
                                                                                                                                                                "PDFBox
                                                                                                                                                                libraries
                                                                                                                                                                not
                                                                                                                                                                found",
                                                                                                                                                                e);
                                                                                                                                                                outJSON.print("{\"success\":
                                                                                                                                                                false,
                                                                                                                                                                \"message\":
                                                                                                                                                                \"PDF
                                                                                                                                                                processing
                                                                                                                                                                libraries
                                                                                                                                                                not
                                                                                                                                                                installed
                                                                                                                                                                or
                                                                                                                                                                incompatible.
                                                                                                                                                                Please
                                                                                                                                                                add
                                                                                                                                                                Apache
                                                                                                                                                                PDFBox
                                                                                                                                                                to
                                                                                                                                                                WEB-INF/lib.\"}");
                                                                                                                                                                return;
                                                                                                                                                                }

                                                                                                                                                                if
                                                                                                                                                                (ServletFileUpload.isMultipartContent(request))
                                                                                                                                                                {
                                                                                                                                                                List
                                                                                                                                                                <FileItem>
                                                                                                                                                                    items
                                                                                                                                                                    =
                                                                                                                                                                    (List
                                                                                                                                                                    <FileItem>
                                                                                                                                                                        )
                                                                                                                                                                        request.getAttribute("multipartItems");

                                                                                                                                                                        if
                                                                                                                                                                        (items
                                                                                                                                                                        ==
                                                                                                                                                                        null)
                                                                                                                                                                        {
                                                                                                                                                                        DiskFileItemFactory
                                                                                                                                                                        factory
                                                                                                                                                                        =
                                                                                                                                                                        new
                                                                                                                                                                        DiskFileItemFactory();
                                                                                                                                                                        ServletFileUpload
                                                                                                                                                                        upload
                                                                                                                                                                        =
                                                                                                                                                                        new
                                                                                                                                                                        ServletFileUpload(factory);
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        items
                                                                                                                                                                        =
                                                                                                                                                                        upload.parseRequest(request);
                                                                                                                                                                        }
                                                                                                                                                                        catch
                                                                                                                                                                        (Exception
                                                                                                                                                                        parseEx)
                                                                                                                                                                        {
                                                                                                                                                                        LOGGER.log(Level.SEVERE,
                                                                                                                                                                        "Error
                                                                                                                                                                        parsing
                                                                                                                                                                        multipart
                                                                                                                                                                        PDF
                                                                                                                                                                        upload",
                                                                                                                                                                        parseEx);
                                                                                                                                                                        JSONObject
                                                                                                                                                                        err
                                                                                                                                                                        =
                                                                                                                                                                        new
                                                                                                                                                                        JSONObject();
                                                                                                                                                                        err.put("success",
                                                                                                                                                                        false);
                                                                                                                                                                        err.put("message",
                                                                                                                                                                        "Error
                                                                                                                                                                        parsing
                                                                                                                                                                        upload:
                                                                                                                                                                        "
                                                                                                                                                                        +
                                                                                                                                                                        parseEx.getMessage());
                                                                                                                                                                        outJSON.print(err.toString());
                                                                                                                                                                        return;
                                                                                                                                                                        }
                                                                                                                                                                        }

                                                                                                                                                                        String
                                                                                                                                                                        extractedText
                                                                                                                                                                        =
                                                                                                                                                                        "";
                                                                                                                                                                        boolean
                                                                                                                                                                        success
                                                                                                                                                                        =
                                                                                                                                                                        false;

                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        for
                                                                                                                                                                        (FileItem
                                                                                                                                                                        item
                                                                                                                                                                        :
                                                                                                                                                                        items)
                                                                                                                                                                        {
                                                                                                                                                                        if
                                                                                                                                                                        (!item.isFormField()
                                                                                                                                                                        &&
                                                                                                                                                                        "pdfFile".equals(item.getFieldName()))
                                                                                                                                                                        {
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        byte[]
                                                                                                                                                                        pdfBytes
                                                                                                                                                                        =
                                                                                                                                                                        item.get();
                                                                                                                                                                        PDDocument
                                                                                                                                                                        document
                                                                                                                                                                        =
                                                                                                                                                                        null;
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        //
                                                                                                                                                                        Load
                                                                                                                                                                        PDF
                                                                                                                                                                        via
                                                                                                                                                                        reflection
                                                                                                                                                                        to
                                                                                                                                                                        support
                                                                                                                                                                        multiple
                                                                                                                                                                        PDFBox
                                                                                                                                                                        versions.
                                                                                                                                                                        //
                                                                                                                                                                        This
                                                                                                                                                                        avoids
                                                                                                                                                                        compile
                                                                                                                                                                        errors
                                                                                                                                                                        when
                                                                                                                                                                        certain
                                                                                                                                                                        overloads
                                                                                                                                                                        do
                                                                                                                                                                        not
                                                                                                                                                                        exist.
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        java.lang.reflect.Method
                                                                                                                                                                        m
                                                                                                                                                                        =
                                                                                                                                                                        PDDocument.class.getMethod("load",
                                                                                                                                                                        byte[].class);
                                                                                                                                                                        document
                                                                                                                                                                        =
                                                                                                                                                                        (PDDocument)
                                                                                                                                                                        m.invoke(null,
                                                                                                                                                                        pdfBytes);
                                                                                                                                                                        }
                                                                                                                                                                        catch
                                                                                                                                                                        (NoSuchMethodException
                                                                                                                                                                        noByteArrayLoad)
                                                                                                                                                                        {
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        java.io.InputStream
                                                                                                                                                                        in
                                                                                                                                                                        =
                                                                                                                                                                        new
                                                                                                                                                                        java.io.ByteArrayInputStream(pdfBytes);
                                                                                                                                                                        java.lang.reflect.Method
                                                                                                                                                                        m
                                                                                                                                                                        =
                                                                                                                                                                        PDDocument.class.getMethod("load",
